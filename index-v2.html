<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MFT Exam Master v2 - Prototype</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #f59e0b;
            --bg: #ffffff;
            --bg-secondary: #f8fafc;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-hover: #60a5fa;
            --bg: #0f172a;
            --bg-secondary: #1e293b;
            --text: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
        }

        /* High Contrast Mode */
        [data-contrast="high"] {
            --primary: #0000ff;
            --primary-hover: #0000cc;
            --bg: #ffffff;
            --bg-secondary: #ffffff;
            --text: #000000;
            --text-light: #000000;
            --border: #000000;
        }

        [data-contrast="high"][data-theme="dark"] {
            --primary: #ffff00;
            --primary-hover: #ffcc00;
            --bg: #000000;
            --bg-secondary: #000000;
            --text: #ffffff;
            --text-light: #ffffff;
            --border: #ffffff;
        }

        /* Dyslexia-friendly font */
        @import url('https://fonts.cdnfonts.com/css/opendyslexic');

        [data-dyslexia="true"] {
            font-family: 'OpenDyslexic', 'Comic Sans MS', cursive, sans-serif !important;
        }

        [data-dyslexia="true"] * {
            font-family: inherit !important;
        }

        /* Font size classes */
        [data-fontsize="small"] { font-size: 14px; }
        [data-fontsize="medium"] { font-size: 16px; }
        [data-fontsize="large"] { font-size: 20px; }

        /* Line height classes */
        [data-lineheight="tight"] { line-height: 1.4; }
        [data-lineheight="normal"] { line-height: 1.6; }
        [data-lineheight="relaxed"] { line-height: 2.0; }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top Navigation Bar */
        .navbar {
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 8px;
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            color: var(--text-light);
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.95rem;
        }

        .nav-link:hover {
            background: var(--bg-secondary);
            color: var(--text);
        }

        .nav-link.active {
            background: var(--primary);
            color: white;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 40px 20px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        /* View Container - only one visible at a time */
        .view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard View - Single Dominant CTA */
        .hero {
            text-align: center;
            padding: 60px 20px;
        }

        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 16px;
            color: var(--text);
        }

        .hero p {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 40px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .cta-primary {
            display: inline-block;
            padding: 18px 48px;
            font-size: 1.2rem;
            font-weight: 600;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-lg);
        }

        .cta-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 60px;
        }

        .stat-card {
            background: var(--bg);
            padding: 24px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 4px;
        }

        /* Study Mode Selection */
        .mode-selection {
            margin-top: 40px;
        }

        .mode-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .mode-card {
            background: var(--bg);
            padding: 24px;
            border-radius: var(--radius);
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-lg);
        }

        .mode-card h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .mode-card p {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        /* Session View */
        .question-card {
            background: var(--bg);
            padding: 32px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .question-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .question-progress {
            font-weight: 600;
            color: var(--text);
        }

        .difficulty-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .difficulty-easy { background: #dcfce7; color: #166534; }
        .difficulty-medium { background: #fef3c7; color: #92400e; }
        .difficulty-hard { background: #fee2e2; color: #991b1b; }

        .question-text {
            font-size: 1.15rem;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option {
            padding: 16px 20px;
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .option:hover {
            border-color: var(--primary);
            background: var(--bg-secondary);
        }

        .option.selected {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
        }

        .option.correct {
            border-color: var(--success);
            background: rgba(22, 163, 74, 0.1);
        }

        .option.incorrect {
            border-color: var(--danger);
            background: rgba(220, 38, 38, 0.1);
        }

        .option-letter {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .feedback {
            margin-top: 24px;
            padding: 20px;
            border-radius: var(--radius);
            background: var(--bg-secondary);
        }

        .feedback h4 {
            margin-bottom: 12px;
            color: var(--success);
        }

        .feedback.incorrect h4 {
            color: var(--danger);
        }

        /* Results View */
        .results-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            box-shadow: var(--shadow-lg);
        }

        .score-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary);
        }

        .score-label {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        /* History View */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            background: var(--bg);
            padding: 20px;
            border-radius: var(--radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .history-info h4 {
            margin-bottom: 4px;
        }

        .history-date {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .history-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Settings View */
        .settings-section {
            background: var(--bg);
            padding: 24px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .settings-section h3 {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .setting-label {
            font-weight: 500;
        }

        .setting-description {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .setting-control {
            display: flex;
            gap: 8px;
        }

        .setting-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            cursor: pointer;
            transition: all 0.2s;
        }

        .setting-btn:hover, .setting-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .hero h1 {
                font-size: 1.8rem;
            }

            .nav-links {
                gap: 4px;
            }

            .nav-link {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .question-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Centralized Navigation Bar -->
    <nav class="navbar">
        <div class="nav-brand">MFT Exam Master</div>
        <div class="nav-links">
            <button class="nav-link active" data-view="dashboard">Home</button>
            <button class="nav-link" data-view="history">History</button>
            <button class="nav-link" data-view="settings">Settings</button>
        </div>
    </nav>

    <!-- Main Content - Single View at a Time -->
    <main class="main-content">

        <!-- Dashboard View -->
        <div id="view-dashboard" class="view active">
            <div class="hero">
                <h1>Ready to Study?</h1>
                <p>Master the MFT licensing exam with 470+ practice questions across all 6 AMFTRB domains.</p>
                <button class="cta-primary" onclick="showModeSelection()">Start Practice Session</button>
            </div>

            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-value" id="stat-sessions">0</div>
                    <div class="stat-label">Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-questions">0</div>
                    <div class="stat-label">Questions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-accuracy">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-streak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            </div>

            <!-- Mode Selection (hidden initially) -->
            <div id="mode-selection" class="mode-selection" style="display: none;">
                <h2 style="text-align: center; margin-bottom: 8px;">Choose Study Mode</h2>
                <p style="text-align: center; color: var(--text-light); margin-bottom: 24px;">Select how you want to practice today</p>

                <div class="mode-cards">
                    <div class="mode-card" onclick="startSession('practice')">
                        <h3>Practice Mode</h3>
                        <p>Get instant feedback after each question with explanations and citations.</p>
                    </div>
                    <div class="mode-card" onclick="startSession('exam')">
                        <h3>Exam Simulation</h3>
                        <p>Timed test with no feedback until the end. Mimics real exam conditions.</p>
                    </div>
                    <div class="mode-card" onclick="startSession('custom')">
                        <h3>Custom Session</h3>
                        <p>Choose specific domains, difficulty levels, and question count.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session View (Quiz) -->
        <div id="view-session" class="view">
            <div class="question-card">
                <div class="question-meta">
                    <span class="question-progress">Question <span id="q-current">1</span> of <span id="q-total">10</span></span>
                    <span class="difficulty-badge difficulty-medium" id="q-difficulty">MEDIUM</span>
                </div>

                <div id="q-vignette" class="vignette" style="display: none; background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px; font-style: italic;"></div>

                <div class="question-text" id="q-text">
                    Loading question...
                </div>

                <div class="options" id="q-options">
                    <!-- Options rendered dynamically -->
                </div>

                <div id="q-feedback" class="feedback" style="display: none;">
                    <h4 id="feedback-title">Correct!</h4>
                    <p id="feedback-text"></p>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousQuestion()">Previous</button>
                    <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()">Next</button>
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="view-results" class="view">
            <div class="results-header">
                <div class="score-circle">
                    <div class="score-value" id="result-score">85%</div>
                    <div class="score-label">Score</div>
                </div>
                <h2>Session Complete!</h2>
                <p style="color: var(--text-light); margin-top: 8px;">
                    You answered <span id="result-correct">17</span> out of <span id="result-total">20</span> questions correctly.
                </p>
            </div>

            <div style="display: flex; gap: 16px; justify-content: center; margin-top: 32px;">
                <button class="btn btn-secondary" onclick="navigate('dashboard')">Back to Home</button>
                <button class="btn btn-primary" onclick="reviewMissed()">Review Missed Questions</button>
            </div>
        </div>

        <!-- History View -->
        <div id="view-history" class="view">
            <h2 style="margin-bottom: 24px;">Study History</h2>

            <div id="history-list" class="history-list">
                <!-- Populated dynamically -->
            </div>

            <div id="history-empty" class="empty-state" style="display: none;">
                <div class="empty-state-icon">ðŸ“š</div>
                <h3>No sessions yet</h3>
                <p>Complete a practice session to see your history here.</p>
            </div>
        </div>

        <!-- Settings View -->
        <div id="view-settings" class="view">
            <h2 style="margin-bottom: 24px;">Settings</h2>

            <div class="settings-section">
                <h3>Appearance</h3>

                <div class="setting-row">
                    <div>
                        <div class="setting-label">Theme</div>
                        <div class="setting-description">Choose your preferred color scheme</div>
                    </div>
                    <div class="setting-control" data-setting="theme">
                        <button class="setting-btn active" data-value="light" onclick="setTheme('light')">Light</button>
                        <button class="setting-btn" data-value="dark" onclick="setTheme('dark')">Dark</button>
                    </div>
                </div>

                <div class="setting-row">
                    <div>
                        <div class="setting-label">Font Size</div>
                        <div class="setting-description">Adjust text size for readability</div>
                    </div>
                    <div class="setting-control" data-setting="fontSize">
                        <button class="setting-btn" data-value="small" onclick="setFontSize('small')">A</button>
                        <button class="setting-btn active" data-value="medium" onclick="setFontSize('medium')">A+</button>
                        <button class="setting-btn" data-value="large" onclick="setFontSize('large')">A++</button>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Accessibility</h3>

                <div class="setting-row">
                    <div>
                        <div class="setting-label">High Contrast</div>
                        <div class="setting-description">Increase contrast for better visibility</div>
                    </div>
                    <div class="setting-control" data-setting="highContrast">
                        <button class="setting-btn active" data-value="false" onclick="toggleContrast(false)">Off</button>
                        <button class="setting-btn" data-value="true" onclick="toggleContrast(true)">On</button>
                    </div>
                </div>

                <div class="setting-row">
                    <div>
                        <div class="setting-label">Dyslexia-Friendly Font</div>
                        <div class="setting-description">Use OpenDyslexic font for easier reading</div>
                    </div>
                    <div class="setting-control" data-setting="dyslexiaFont">
                        <button class="setting-btn active" data-value="false" onclick="toggleDyslexia(false)">Off</button>
                        <button class="setting-btn" data-value="true" onclick="toggleDyslexia(true)">On</button>
                    </div>
                </div>

                <div class="setting-row">
                    <div>
                        <div class="setting-label">Line Spacing</div>
                        <div class="setting-description">Adjust space between lines</div>
                    </div>
                    <div class="setting-control" data-setting="lineHeight">
                        <button class="setting-btn" data-value="tight" onclick="setLineHeight('tight')">Tight</button>
                        <button class="setting-btn active" data-value="normal" onclick="setLineHeight('normal')">Normal</button>
                        <button class="setting-btn" data-value="relaxed" onclick="setLineHeight('relaxed')">Relaxed</button>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Data</h3>

                <div class="setting-row">
                    <div>
                        <div class="setting-label">Clear All Data</div>
                        <div class="setting-description">Reset all progress and settings</div>
                    </div>
                    <button class="btn btn-secondary" style="color: var(--danger);" onclick="clearData()">Clear Data</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // =====================================================
        // STATE MANAGEMENT - Single source of truth
        // =====================================================
        const state = {
            currentView: 'dashboard',
            studyMode: null,
            questions: [],
            currentSession: {
                questions: [],
                currentIndex: 0,
                answers: {},
                shuffledOptions: {}
            },
            stats: {
                totalSessions: 0,
                totalQuestions: 0,
                totalCorrect: 0
            },
            history: [],
            settings: {
                theme: 'light',
                fontSize: 'medium',
                highContrast: false,
                dyslexiaFont: false,
                lineHeight: 'normal'
            }
        };

        // =====================================================
        // NAVIGATION - Centralized view switching
        // =====================================================
        function navigate(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

            // Show target view
            const targetView = document.getElementById(`view-${viewName}`);
            if (targetView) {
                targetView.classList.add('active');
                state.currentView = viewName;
            }

            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.view === viewName);
            });

            // Hide mode selection when leaving dashboard
            if (viewName !== 'dashboard') {
                document.getElementById('mode-selection').style.display = 'none';
            }
        }

        // Set up nav link clicks
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => navigate(link.dataset.view));
        });

        // =====================================================
        // DASHBOARD
        // =====================================================
        function showModeSelection() {
            document.getElementById('mode-selection').style.display = 'block';
            document.getElementById('mode-selection').scrollIntoView({ behavior: 'smooth' });
        }

        function updateStats() {
            document.getElementById('stat-sessions').textContent = state.stats.totalSessions;
            document.getElementById('stat-questions').textContent = state.stats.totalQuestions;
            const accuracy = state.stats.totalQuestions > 0
                ? Math.round((state.stats.totalCorrect / state.stats.totalQuestions) * 100)
                : 0;
            document.getElementById('stat-accuracy').textContent = accuracy + '%';
            document.getElementById('stat-streak').textContent = '0'; // Simplified
        }

        // =====================================================
        // SESSION
        // =====================================================
        async function startSession(mode) {
            state.studyMode = mode;

            // Load questions (simplified - just load domain 1)
            try {
                const response = await fetch('questions/domain1_systemic_therapy.json');
                const questions = await response.json();

                // Take 10 random questions for demo
                const shuffled = questions.sort(() => Math.random() - 0.5);
                state.currentSession = {
                    questions: shuffled.slice(0, 10),
                    currentIndex: 0,
                    answers: {},
                    shuffledOptions: {}
                };

                navigate('session');
                showQuestion();
            } catch (err) {
                console.error('Failed to load questions:', err);
                alert('Failed to load questions. Make sure you\'re running from a local server.');
            }
        }

        function getShuffledOptions(questionId, numOptions) {
            const session = state.currentSession;
            if (!session.shuffledOptions) session.shuffledOptions = {};
            if (session.shuffledOptions[questionId]) {
                return session.shuffledOptions[questionId];
            }
            const indices = Array.from({ length: numOptions }, (_, i) => i);
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            session.shuffledOptions[questionId] = indices;
            return indices;
        }

        function showQuestion() {
            const session = state.currentSession;
            const question = session.questions[session.currentIndex];
            const shuffled = getShuffledOptions(question.id, question.options.length);
            const isAnswered = session.answers[question.id] !== undefined;

            document.getElementById('q-current').textContent = session.currentIndex + 1;
            document.getElementById('q-total').textContent = session.questions.length;
            document.getElementById('q-difficulty').textContent = question.difficulty.toUpperCase();
            document.getElementById('q-difficulty').className = `difficulty-badge difficulty-${question.difficulty}`;
            document.getElementById('q-text').textContent = question.question;

            // Vignette
            const vignetteEl = document.getElementById('q-vignette');
            if (question.vignette) {
                vignetteEl.textContent = question.vignette;
                vignetteEl.style.display = 'block';
            } else {
                vignetteEl.style.display = 'none';
            }

            // Options
            const optionsHtml = shuffled.map((originalIdx, displayIdx) => {
                const opt = question.options[originalIdx];
                const isSelected = session.answers[question.id] === originalIdx;
                const isCorrect = originalIdx === question.correct;

                let classes = 'option';
                if (isAnswered) {
                    if (isCorrect) classes += ' correct';
                    else if (isSelected) classes += ' incorrect';
                }
                if (isSelected) classes += ' selected';

                return `
                    <div class="${classes}" onclick="selectAnswer(${originalIdx})" ${isAnswered ? 'style="pointer-events: none;"' : ''}>
                        <span class="option-letter">${String.fromCharCode(65 + displayIdx)}</span>
                        <span>${opt}</span>
                    </div>
                `;
            }).join('');
            document.getElementById('q-options').innerHTML = optionsHtml;

            // Feedback
            const feedbackEl = document.getElementById('q-feedback');
            if (isAnswered && state.studyMode === 'practice') {
                const isCorrect = session.answers[question.id] === question.correct;
                feedbackEl.style.display = 'block';
                feedbackEl.className = 'feedback' + (isCorrect ? '' : ' incorrect');
                document.getElementById('feedback-title').textContent = isCorrect ? 'Correct!' : 'Incorrect';
                document.getElementById('feedback-text').textContent = question.explanation;
            } else {
                feedbackEl.style.display = 'none';
            }

            // Update next button
            const isLast = session.currentIndex === session.questions.length - 1;
            document.getElementById('next-btn').textContent = isLast ? 'Finish' : 'Next';
        }

        function selectAnswer(optionIndex) {
            const session = state.currentSession;
            const question = session.questions[session.currentIndex];

            if (session.answers[question.id] !== undefined) return; // Already answered

            session.answers[question.id] = optionIndex;
            showQuestion(); // Re-render with feedback
        }

        function nextQuestion() {
            const session = state.currentSession;

            if (session.currentIndex < session.questions.length - 1) {
                session.currentIndex++;
                showQuestion();
            } else {
                finishSession();
            }
        }

        function previousQuestion() {
            const session = state.currentSession;
            if (session.currentIndex > 0) {
                session.currentIndex--;
                showQuestion();
            }
        }

        function finishSession() {
            const session = state.currentSession;
            let correct = 0;
            let total = session.questions.length;

            session.questions.forEach(q => {
                if (session.answers[q.id] === q.correct) correct++;
            });

            // Update stats
            state.stats.totalSessions++;
            state.stats.totalQuestions += total;
            state.stats.totalCorrect += correct;

            // Add to history
            state.history.unshift({
                date: new Date().toISOString(),
                mode: state.studyMode,
                score: Math.round((correct / total) * 100),
                correct,
                total
            });

            // Show results
            document.getElementById('result-score').textContent = Math.round((correct / total) * 100) + '%';
            document.getElementById('result-correct').textContent = correct;
            document.getElementById('result-total').textContent = total;

            navigate('results');
            saveData();
        }

        function reviewMissed() {
            alert('Review missed questions feature - would show detailed review of incorrect answers');
        }

        // =====================================================
        // HISTORY
        // =====================================================
        function renderHistory() {
            const list = document.getElementById('history-list');
            const empty = document.getElementById('history-empty');

            if (state.history.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            list.style.display = 'flex';

            list.innerHTML = state.history.slice(0, 10).map(session => {
                const date = new Date(session.date);
                return `
                    <div class="history-item">
                        <div class="history-info">
                            <h4>${session.mode === 'practice' ? 'Practice' : 'Exam'} Session</h4>
                            <div class="history-date">${date.toLocaleDateString()} at ${date.toLocaleTimeString()}</div>
                        </div>
                        <div class="history-score">${session.score}%</div>
                    </div>
                `;
            }).join('');
        }

        // =====================================================
        // SETTINGS
        // =====================================================
        function setTheme(theme) {
            state.settings.theme = theme;
            document.body.dataset.theme = theme;
            updateSettingButtons('theme', theme);
            saveData();
        }

        function setFontSize(size) {
            state.settings.fontSize = size;
            document.body.dataset.fontsize = size;
            updateSettingButtons('fontSize', size);
            saveData();
        }

        function toggleContrast(on) {
            state.settings.highContrast = on;
            document.body.dataset.contrast = on ? 'high' : 'normal';
            updateSettingButtons('highContrast', String(on));
            saveData();
        }

        function toggleDyslexia(on) {
            state.settings.dyslexiaFont = on;
            document.body.dataset.dyslexia = String(on);
            updateSettingButtons('dyslexiaFont', String(on));
            saveData();
        }

        function setLineHeight(height) {
            state.settings.lineHeight = height;
            document.body.dataset.lineheight = height;
            updateSettingButtons('lineHeight', height);
            saveData();
        }

        function updateSettingButtons(setting, value) {
            const control = document.querySelector(`[data-setting="${setting}"]`);
            if (!control) return;

            control.querySelectorAll('.setting-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === String(value));
            });
        }

        function clearData() {
            if (confirm('Are you sure? This will delete all your progress.')) {
                localStorage.removeItem('mft_v2_data');
                location.reload();
            }
        }

        // =====================================================
        // PERSISTENCE
        // =====================================================
        function saveData() {
            const data = {
                stats: state.stats,
                history: state.history,
                settings: state.settings
            };
            localStorage.setItem('mft_v2_data', JSON.stringify(data));
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('mft_v2_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.stats = data.stats || state.stats;
                    state.history = data.history || [];
                    state.settings = data.settings || state.settings;
                }
            } catch (e) {
                console.error('Failed to load saved data:', e);
            }
        }

        // =====================================================
        // INITIALIZATION
        // =====================================================
        function applyAllSettings() {
            // Theme
            document.body.dataset.theme = state.settings.theme || 'light';
            updateSettingButtons('theme', state.settings.theme || 'light');

            // Font size
            document.body.dataset.fontsize = state.settings.fontSize || 'medium';
            updateSettingButtons('fontSize', state.settings.fontSize || 'medium');

            // High contrast
            document.body.dataset.contrast = state.settings.highContrast ? 'high' : 'normal';
            updateSettingButtons('highContrast', String(state.settings.highContrast || false));

            // Dyslexia font
            document.body.dataset.dyslexia = String(state.settings.dyslexiaFont || false);
            updateSettingButtons('dyslexiaFont', String(state.settings.dyslexiaFont || false));

            // Line height
            document.body.dataset.lineheight = state.settings.lineHeight || 'normal';
            updateSettingButtons('lineHeight', state.settings.lineHeight || 'normal');
        }

        function init() {
            loadData();
            updateStats();
            renderHistory();
            applyAllSettings();
        }

        init();
    </script>
</body>
</html>
