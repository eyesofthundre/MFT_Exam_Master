<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MFT Exam">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Your complete study companion for the Marriage and Family Therapy National Examination. Practice questions, exam simulations, and progress tracking.">
    <title>MFT Exam Master - Your Personal Study Companion</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap');
        
        :root {
            --primary: #3B82F6;
            --primary-dark: #2563EB;
            --primary-light: #DBEAFE;
            --success: #10B981;
            --success-light: #D1FAE5;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --danger: #EF4444;
            --danger-light: #FEE2E2;
            --purple: #8B5CF6;
            --purple-light: #EDE9FE;
            --bg: #F9FAFB;
            --surface: #FFFFFF;
            --text: #111827;
            --text-light: #374151;
            --border: #E5E7EB;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 19px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport height for iOS Safari */
            -webkit-font-smoothing: antialiased;
            -webkit-text-size-adjust: 100%;
            /* Safe area padding for notched devices */
            padding-top: env(safe-area-inset-top);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Disable background-attachment: fixed on mobile for performance */
        @media (max-width: 768px) {
            body {
                background-attachment: scroll;
            }
        }

        /* iOS-specific tap highlight removal */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ===================================
           FONT SCALING FIX - OVERRIDES EVERYTHING
           Forces ALL content to scale with accessibility slider
           =================================== */
        
        /* Force EVERY element in content areas to inherit font size */
        .card *,
        #studySession *,
        #sessionReview *,
        #missedQuestionsReview *,
        #sessionHistory *,
        #studyNotes *,
        #reportCard *,
        .question-card *,
        .review-question * {
            font-size: inherit !important;
        }
        
        /* Exceptions: Keep UI elements at fixed size */
        .btn,
        .btn *,
        .header,
        .header *,
        .settings-btn,
        .accessibility-panel,
        .accessibility-panel *,
        .filter-btn,
        .user-info,
        .user-info *,
        .logo,
        .logo * {
            font-size: 1rem !important;
        }
        
        /* Small UI text */
        .range-labels,
        .range-labels *,
        .session-badge {
            font-size: 0.75rem !important;
        }
        
        /* Main content text that should scale */
        .question-card h3,
        .question-card p,
        .question-text,
        .vignette,
        .answer-option,
        .explanation,
        .explanation p,
        .citation,
        .review-question,
        .review-question p,
        .review-question div,
        .note-textarea,
        .session-history-card,
        #missedQuestionsList,
        #reviewQuestionsList,
        #studyNotesList,
        .domain-performance,
        #resultDetail,
        #domainResults {
            font-size: 1em !important;  /* Inherit from body */
        }
        
        /* Slightly larger for question headings */
        .question-card h3 {
            font-size: 1.15em !important;
        }
        
        /* Keep proportions for very large text */
        body[style*="font-size: 4"] .question-card h3,
        body[style*="font-size: 5"] .question-card h3,
        body[style*="font-size: 6"] .question-card h3,
        body[style*="font-size: 7"] .question-card h3,
        body[style*="font-size: 8"] .question-card h3 {
            font-size: 1.05em !important;  /* Less dramatic at huge sizes */
        }
        
        /* UI elements stay readable but smaller */
        .btn,
        .header h1,
        .logo h1,
        .user-info,
        .settings-btn,
        .filter-btn,
        label {
            font-size: 1rem !important;  /* Fixed at 16px */
        }
        
        /* Small UI text stays small */
        .range-labels,
        .domain-bar,
        .stat-card .label,
        .session-badge {
            font-size: 0.75rem !important;  /* Fixed at 12px */
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .logo h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--bg);
            padding: 12px 20px;
            border-radius: 50px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--success) 0%, var(--primary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .settings-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            margin-left: 5px;
        }

        .settings-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .settings-btn:active {
            transform: scale(0.95);
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px var(--shadow);
        }
        
        .card h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--text);
        }
        
        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
        }
        
        .welcome-screen h2 {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .welcome-screen p {
            font-size: 1.2rem;
            color: var(--text-light);
            margin-bottom: 30px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }
        
        .input-group input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: var(--primary-light);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #DC2626;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .option-card {
            background: var(--bg);
            border: 3px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .option-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px var(--shadow);
        }
        
        .option-card.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        
        .option-card .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .option-card h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .option-card p {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: var(--bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .checkbox-item:hover {
            background: var(--primary-light);
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            min-width: 24px;
            cursor: pointer;
            /* Touch-friendly tap area */
            position: relative;
        }

        .checkbox-item input[type="checkbox"]::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 44px;
            height: 44px;
        }
        
        .question-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            border-left: 6px solid var(--primary);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .question-number {
            background: var(--primary);
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 600;
        }
        
        .difficulty-badge {
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .difficulty-easy {
            background: var(--success-light);
            color: var(--success);
        }
        
        .difficulty-medium {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .difficulty-hard {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        .question-text {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .vignette {
            background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%);
            border-left: 4px solid var(--warning);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-style: italic;
            color: #78350F;
        }
        
        .answers {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .answer-option {
            display: flex;
            align-items: start;
            padding: 18px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .answer-option:hover {
            border-color: var(--primary);
            background: var(--primary-light);
            transform: translateX(5px);
        }
        
        .answer-option input[type="radio"] {
            margin-top: 3px;
            margin-right: 12px;
            width: 24px;
            height: 24px;
            min-width: 24px;
            cursor: pointer;
            /* Touch-friendly - the whole .answer-option is tappable */
        }
        
        .answer-option label {
            cursor: pointer;
            flex: 1;
            font-size: 1.05rem;
        }
        
        .answer-option.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        
        .answer-option.correct {
            border-color: var(--success);
            background: var(--success-light);
        }
        
        .answer-option.incorrect {
            border-color: var(--danger);
            background: var(--danger-light);
        }
        
        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .feedback.correct {
            background: var(--success-light);
            border-left: 4px solid var(--success);
        }
        
        .feedback.incorrect {
            background: var(--danger-light);
            border-left: 4px solid var(--danger);
        }
        
        .feedback h4 {
            margin-bottom: 10px;
            color: var(--text);
        }
        
        .feedback p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .citation {
            background: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 10px;
        }

        .study-links {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border);
        }

        .study-links strong {
            display: block;
            margin-bottom: 8px;
            color: var(--text);
        }

        .study-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            padding: 6px 12px;
            background: var(--primary-light);
            border-radius: 6px;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .study-link:hover {
            background: var(--primary);
            color: white;
            text-decoration: none;
        }

        body.theme-dark .study-link {
            background: rgba(59, 130, 246, 0.2);
        }

        body.theme-dark .study-link:hover {
            background: var(--primary);
        }

        /* Memory Tip Styling */
        .memory-tip {
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, var(--purple-light) 0%, #faf5ff 100%);
            border-radius: 12px;
            border-left: 4px solid var(--purple);
        }

        .memory-tip-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--purple);
            margin-bottom: 8px;
        }

        .memory-tip-content {
            color: var(--text);
            line-height: 1.6;
        }

        body.theme-dark .memory-tip {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        /* Question Rating Styles */
        .question-rating {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border);
        }

        .rating-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 10px;
            display: block;
        }

        .rating-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .rating-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: 2px solid var(--border);
            border-radius: 20px;
            background: var(--bg);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            color: var(--text);
        }

        .rating-btn:hover {
            transform: scale(1.02);
        }

        .rating-btn.rating-good:hover,
        .rating-btn.rating-good.selected {
            background: var(--success-light);
            border-color: var(--success);
            color: var(--success);
        }

        .rating-btn.rating-irrelevant:hover,
        .rating-btn.rating-irrelevant.selected {
            background: var(--warning-light);
            border-color: var(--warning);
            color: #b45309;
        }

        .rating-btn.rating-incorrect:hover,
        .rating-btn.rating-incorrect.selected {
            background: var(--danger-light);
            border-color: var(--danger);
            color: var(--danger);
        }

        .rating-btn.rating-issue:hover,
        .rating-btn.rating-issue.selected {
            background: var(--purple-light);
            border-color: var(--purple);
            color: var(--purple);
        }

        .rating-btn.selected {
            font-weight: 600;
        }

        .rating-thanks {
            font-size: 0.85rem;
            color: var(--success);
            font-style: italic;
            margin-top: 10px;
            display: block;
        }

        .progress-bar-container {
            background: var(--bg);
            height: 10px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--primary) 100%);
            transition: width 0.3s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--bg);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .report-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: 700;
            color: white;
            position: relative;
        }
        
        .score-circle.passing {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }
        
        .score-circle.failing {
            background: linear-gradient(135deg, var(--warning) 0%, #D97706 100%);
        }
        
        .score-label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 5px;
        }
        
        .domain-performance {
            margin-top: 30px;
        }
        
        .domain-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .domain-name {
            font-weight: 600;
        }
        
        .domain-score {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .domain-bar {
            width: 200px;
            height: 8px;
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .domain-bar-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 10px;
        }
        
        .history-item {
            background: var(--bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .history-date {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .history-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .resource-card {
            background: var(--bg);
            padding: 20px;
            border-radius: 12px;
            transition: all 0.3s;
        }
        
        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px var(--shadow);
        }
        
        .resource-card h3 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .resource-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .resource-link:hover {
            text-decoration: underline;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .hidden {
            display: none !important;
        }

        /* ===================================
           QUESTION PALETTE / NAVIGATION GRID
           =================================== */

        .question-palette {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px var(--shadow);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            border-left: 6px solid var(--primary);
        }

        /* Match question card styling for consistency */
        #studySession .question-palette {
            margin-top: 20px;
        }

        .question-palette h3 {
            margin-bottom: 15px;
            font-size: 1rem;
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .palette-toggle {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .palette-toggle:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .palette-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            max-height: none;
            overflow-y: visible;
            padding: 15px 0;
            width: 100%;
        }

        .palette-grid.collapsed {
            display: none;
        }

        .palette-item {
            width: 100%;
            height: 50px;
            min-width: 50px;
            border-radius: 8px;
            border: 2px solid #f59e0b;
            background: #fef3c7;
            color: #b45309;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .palette-item:hover {
            border-color: var(--primary);
            transform: scale(1.05);
            background: #fde68a;
        }

        .palette-item.current {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        .palette-item.answered {
            border-color: var(--success);
            background: #d1fae5;
            color: #047857;
        }

        .palette-item.answered.current {
            background: var(--success);
            border-color: var(--success);
            color: white;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }

        .palette-item.skipped {
            border-color: var(--warning);
            background: var(--warning-light);
            color: var(--warning);
        }

        .palette-item.flagged {
            border-color: #9333ea;
            background: #f3e8ff;
            color: #9333ea;
            position: relative;
        }

        .palette-item.flagged::after {
            content: 'ðŸš©';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 10px;
        }

        .mark-review-btn {
            background: #f3e8ff;
            color: #9333ea;
            border: 2px solid #9333ea;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mark-review-btn:hover {
            background: #9333ea;
            color: white;
        }

        .mark-review-btn.flagged {
            background: #9333ea;
            color: white;
        }

        .palette-legend {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }

        .legend-dot.current {
            background: var(--primary);
        }

        .legend-dot.answered {
            background: var(--success-light);
            border: 1px solid var(--success);
        }

        .legend-dot.unanswered {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .question-palette.navigator-hidden {
            display: none;
        }

        .show-navigator-btn {
            width: 100%;
            margin-top: 20px;
            padding: 12px;
            font-size: 0.95rem;
        }

        .skip-btn {
            background: var(--warning-light);
            color: var(--warning);
            border: 2px solid var(--warning);
        }

        .skip-btn:hover {
            background: var(--warning);
            color: white;
        }

        /* Touch-friendly active states for all devices */
        .btn:active,
        .option-card:active,
        .answer-option:active,
        .palette-item:active,
        .session-history-card:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* Only show hover effects on devices with hover capability */
        @media (hover: hover) {
            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
            }

            .btn-secondary:hover,
            .btn-success:hover {
                transform: translateY(-2px);
            }

            .option-card:hover {
                transform: translateY(-5px);
                border-color: var(--primary);
            }

            .answer-option:hover:not(.correct):not(.incorrect) {
                background: var(--primary-light);
                border-color: var(--primary);
            }

            .checkbox-item:hover {
                background: var(--primary-light);
            }

            .palette-item:hover:not(.current):not(.answered):not(.flagged) {
                background: var(--primary-light);
                border-color: var(--primary);
            }

            .session-history-card:hover {
                border-color: var(--primary);
                transform: translateY(-2px);
            }

            .study-link:hover {
                background: var(--primary);
                color: white;
            }
        }

        /* Tablet breakpoint */
        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .logo h1 {
                font-size: 1.4rem;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .domain-bar {
                width: 100px;
            }

            /* Fix accessibility panel on tablets/phones */
            .accessibility-panel {
                width: calc(100vw - 40px);
                max-width: 340px;
                right: 20px;
                left: auto;
            }
        }

        /* Phone breakpoint */
        @media (max-width: 480px) {
            .accessibility-panel {
                width: calc(100vw - 20px);
                right: 10px;
                left: 10px;
                bottom: 80px;
                max-width: none;
            }

            .settings-btn {
                width: 35px;
                height: 35px;
            }

            .question-card {
                padding: 20px;
            }

            .palette-grid {
                grid-template-columns: repeat(auto-fill, minmax(44px, 1fr));
                gap: 8px;
            }

            .palette-item {
                width: 44px;
                height: 44px;
                min-width: 44px;
                font-size: 0.85rem;
            }
        }

        /* Small phone breakpoint */
        @media (max-width: 375px) {
            .header {
                padding: 15px;
                flex-direction: column;
                gap: 10px;
            }

            .logo h1 {
                font-size: 1.2rem;
            }

            .user-info {
                align-self: flex-end;
            }

            .question-card {
                padding: 15px;
            }
        }

        /* ===================================
           ANDROID FOLDABLE & LARGE SCREEN SUPPORT
           =================================== */

        /* Foldable devices in unfolded state (Samsung Fold, etc.) */
        @media (horizontal-viewport-segments: 2) {
            .app-container {
                display: grid;
                grid-template-columns: env(viewport-segment-width 0 0) env(viewport-segment-width 1 0);
                gap: 0;
            }

            /* Left panel: navigation/dashboard */
            .card:not(#studySession .card) {
                grid-column: 1;
            }

            /* Right panel: question content */
            #studySession {
                grid-column: 2;
                position: sticky;
                top: 0;
                height: 100vh;
                overflow-y: auto;
            }
        }

        /* Large tablets and desktop - two column layout */
        @media (min-width: 1024px) {
            .app-container {
                max-width: 1400px;
            }

            .options-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .resources-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            /* Side-by-side layout for study session - DISABLED for reliability */
            /* Navigation was getting lost in grid layout, using simpler approach */
            #studySession {
                display: block;
            }

            /* Question navigator stays full-width at bottom for easy access */
            #studySession .question-palette {
                position: relative;
                width: 100%;
                max-width: 100%;
                margin-top: 25px;
            }

            /* Ensure palette grid fills width */
            #studySession .palette-grid {
                grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
            }

            /* Ensure navigation card is always visible */
            #navigationCard {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
        }

        /* Landscape orientation on mobile - optimize for wider view */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 10px 20px;
            }

            .question-card {
                padding: 15px;
            }

            .answer-option {
                padding: 12px 15px;
            }

            .feedback {
                padding: 15px;
            }
        }

        /* Android-specific touch optimizations */
        @supports (-webkit-touch-callout: none) or (touch-action: manipulation) {
            .btn,
            .option-card,
            .answer-option,
            .palette-item,
            .checkbox-item,
            .session-history-card {
                touch-action: manipulation;
                -webkit-touch-callout: none;
                user-select: none;
                -webkit-user-select: none;
            }
        }

        /* ===================================
           ACCESSIBILITY ENHANCEMENTS
           =================================== */
        
        /* Accessibility Panel */
        .accessibility-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 340px;
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 9998;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .accessibility-panel h3 {
            margin: 0 0 20px 0;
            color: var(--text);
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .accessibility-section {
            margin-bottom: 24px;
        }
        
        .accessibility-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
        }
        
        .accessibility-section input[type="range"] {
            width: 100%;
            cursor: pointer;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
        }
        
        .accessibility-section input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }
        
        .accessibility-section select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
        }
        
        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 4px;
        }
        
        .font-size-display {
            display: inline-block;
            margin-left: 8px;
            color: var(--primary);
            font-weight: 600;
        }
        
        /* Theme Styles */
        body.theme-dark {
            --bg: #1e293b;
            --surface: #0f172a;
            --text: #e2e8f0;
            --text-light: #94a3b8;
            --border: #334155;
            --success-light: #14532d;
            --danger-light: #7f1d1d;
            --warning-light: #78350f;
            --primary-light: #1e3a5f;
            --purple-light: #3b0764;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        
        body.theme-dark .card,
        body.theme-dark .header,
        body.theme-dark .question-card,
        body.theme-dark .accessibility-panel {
            background: #0f172a;
            color: #e2e8f0;
        }
        
        body.theme-dark .btn {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
        }

        body.theme-dark .btn-secondary {
            background: #334155;
            color: #e2e8f0;
            border-color: #64748b;
        }

        body.theme-dark .btn-secondary:hover {
            background: #475569;
        }

        body.theme-dark .question-palette {
            background: #1e293b;
            border-color: #3b82f6;
        }

        body.theme-dark .question-palette h3 {
            color: #e2e8f0;
        }

        body.theme-dark .palette-item {
            background: #78350f;
            border-color: #f59e0b;
            color: #fef3c7;
        }

        body.theme-dark .palette-item:hover {
            background: #92400e;
        }

        body.theme-dark .palette-item.current {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }

        body.theme-dark .palette-item.answered {
            background: #14532d;
            border-color: #10b981;
            color: #a7f3d0;
        }

        body.theme-dark .palette-item.answered.current {
            background: #059669;
            border-color: #10b981;
            color: white;
        }

        body.theme-dark .review-question {
            background: #1e293b;
            color: #e2e8f0;
        }

        body.theme-dark .review-question * {
            color: #e2e8f0;
        }

        body.theme-dark .answer-option {
            background: #1e293b;
            border-color: #475569;
            color: #e2e8f0;
        }

        body.theme-dark .answer-option.user-answer {
            background: #7f1d1d;
            border-color: #ef4444;
            color: #fecaca;
        }

        body.theme-dark .answer-option.correct-answer,
        body.theme-dark .answer-option.user-answer.correct-answer {
            background: #14532d;
            border-color: #10b981;
            color: #a7f3d0;
        }

        body.theme-dark .feedback {
            background: #1e293b;
            color: #e2e8f0;
        }

        body.theme-dark .feedback.correct {
            background: #14532d;
            border-color: #10b981;
        }

        body.theme-dark .feedback.incorrect {
            background: #7f1d1d;
            border-color: #ef4444;
        }

        body.theme-dark .citation,
        body.theme-dark .study-links,
        body.theme-dark .memory-tip {
            background: #334155;
            color: #e2e8f0;
        }

        body.theme-dark .option-card {
            background: #1e293b;
            color: #e2e8f0;
        }

        body.theme-dark .option-card:hover {
            background: #334155;
        }

        body.theme-dark input,
        body.theme-dark select,
        body.theme-dark textarea {
            background: #1e293b;
            color: #e2e8f0;
            border-color: #475569;
        }

        body.theme-dark .checkbox-item label {
            color: #e2e8f0;
        }

        /* Dark mode: Ensure all text on colored backgrounds is readable */
        body.theme-dark [style*="background: var(--success-light)"],
        body.theme-dark [style*="background: var(--danger-light)"],
        body.theme-dark [style*="background: var(--warning-light)"],
        body.theme-dark [style*="background: var(--primary-light)"] {
            color: #e2e8f0 !important;
        }

        body.theme-dark [style*="background: var(--success-light)"] *,
        body.theme-dark [style*="background: var(--danger-light)"] *,
        body.theme-dark [style*="background: var(--warning-light)"] *,
        body.theme-dark [style*="background: var(--primary-light)"] * {
            color: #e2e8f0 !important;
        }

        body.theme-dark .score-circle {
            background: #1e293b;
            color: #e2e8f0;
        }

        body.theme-dark .vignette {
            background: #334155;
            color: #e2e8f0;
        }

        body.theme-highcontrast {
            --bg: #000000;
            --surface: #000000;
            --text: #FFFFFF;
            --text-light: #FFFFFF;
            --border: #FFFFFF;
            --success-light: #000000;
            --danger-light: #000000;
            --warning-light: #000000;
            --primary-light: #000000;
            --purple-light: #000000;
            background: #000000;
        }
        
        body.theme-highcontrast .card,
        body.theme-highcontrast .header,
        body.theme-highcontrast .question-card,
        body.theme-highcontrast .accessibility-panel {
            background: #000000;
            color: #FFFFFF;
            border: 3px solid #FFFFFF;
        }
        
        body.theme-highcontrast .btn {
            background: #FFFFFF;
            color: #000000;
            border: 3px solid #FFFFFF;
        }

        body.theme-highcontrast .review-question,
        body.theme-highcontrast .answer-option,
        body.theme-highcontrast .feedback,
        body.theme-highcontrast .option-card {
            background: #000000;
            color: #FFFFFF;
            border: 2px solid #FFFFFF;
        }

        body.theme-highcontrast .review-question *,
        body.theme-highcontrast .answer-option *,
        body.theme-highcontrast .feedback * {
            color: #FFFFFF;
        }

        body.theme-highcontrast .answer-option.user-answer {
            background: #000000;
            border: 3px solid #FF0000;
        }

        body.theme-highcontrast .answer-option.correct-answer {
            background: #000000;
            border: 3px solid #00FF00;
        }

        body.theme-highcontrast .feedback.correct {
            border: 3px solid #00FF00;
        }

        body.theme-highcontrast .feedback.incorrect {
            border: 3px solid #FF0000;
        }

        body.theme-highcontrast .citation,
        body.theme-highcontrast .study-links,
        body.theme-highcontrast .memory-tip {
            background: #000000;
            color: #FFFFFF;
            border: 2px solid #FFFFFF;
        }

        body.theme-highcontrast input,
        body.theme-highcontrast select,
        body.theme-highcontrast textarea {
            background: #000000;
            color: #FFFFFF;
            border: 2px solid #FFFFFF;
        }

        /* High contrast: Ensure ALL text is white on black */
        body.theme-highcontrast [style*="background: var(--success-light)"],
        body.theme-highcontrast [style*="background: var(--danger-light)"],
        body.theme-highcontrast [style*="background: var(--warning-light)"],
        body.theme-highcontrast [style*="background: var(--primary-light)"] {
            color: #FFFFFF !important;
            border: 2px solid #FFFFFF !important;
        }

        body.theme-highcontrast [style*="background: var(--success-light)"] *,
        body.theme-highcontrast [style*="background: var(--danger-light)"] *,
        body.theme-highcontrast [style*="background: var(--warning-light)"] *,
        body.theme-highcontrast [style*="background: var(--primary-light)"] * {
            color: #FFFFFF !important;
        }

        body.theme-highcontrast .score-circle,
        body.theme-highcontrast .vignette {
            background: #000000;
            color: #FFFFFF;
            border: 2px solid #FFFFFF;
        }

        body.theme-dyslexia {
            --bg: #fffbeb;
            --surface: #fefce8;
            --text: #292524;
            --text-light: #44403c;
            --border: #fef3c7;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            font-family: 'Comic Sans MS', 'OpenDyslexic', sans-serif;
        }
        
        body.theme-dyslexia .card,
        body.theme-dyslexia .header,
        body.theme-dyslexia .question-card,
        body.theme-dyslexia .accessibility-panel {
            background: #fffbeb;
            color: #292524;
        }
        
        /* Session History Styles */
        .session-history-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .session-history-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .session-date {
            font-weight: 600;
            color: var(--text);
            font-size: 1.1rem;
        }
        
        .session-score {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .session-score.passing {
            color: var(--success);
        }
        
        .session-score.failing {
            color: var(--danger);
        }
        
        .session-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .session-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        /* Review Interface */
        .review-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: var(--surface);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .review-question {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border-left: 4px solid var(--border);
        }
        
        .review-question.correct {
            border-left-color: var(--success);
        }
        
        .review-question.incorrect {
            border-left-color: var(--danger);
        }
        
        .answer-option.user-answer {
            background: #fef2f2;
            border-color: var(--danger);
            font-weight: 600;
        }
        
        .answer-option.user-answer.correct-answer {
            background: var(--success-light);
            border-color: var(--success);
        }
        
        .answer-option.correct-answer {
            background: var(--success-light);
            border-color: var(--success);
            font-weight: 600;
        }
        
        /* Notes System */
        .note-section {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg);
            border-radius: 8px;
        }
        
        .note-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
        }
        
        .note-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--warning-light);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--warning);
            margin-left: 8px;
        }
        
        .flag-btn {
            padding: 8px 16px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .flag-btn.flagged {
            background: var(--danger-light);
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .navigation-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* FAILSAFE: Ensure navigation card is ALWAYS visible */
        #navigationCard {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
        }

        #navigationCard .action-buttons {
            display: flex !important;
        }

        #navigationCard .btn {
            display: inline-flex !important;
        }

        /* ===================================
           NUCLEAR OVERRIDE - MUST BE LAST
           This overrides ALL previous font-size declarations
           =================================== */
        
        /* Force ALL text in main content to inherit from body */
        .card > *,
        .card > * > *,
        .card > * > * > *,
        .question-card,
        .question-card *,
        .answer-option,
        .vignette,
        .explanation,
        .review-question,
        .review-question *,
        #missedQuestionsList,
        #missedQuestionsList *,
        #reviewQuestionsList,
        #reviewQuestionsList *,
        #sessionHistoryList,
        #sessionHistoryList *,
        #studyNotesList,
        #studyNotesList *,
        #questionDisplay,
        #questionDisplay * {
            font-size: 1em !important;
            line-height: inherit !important;
        }
        
        /* Keep buttons/UI usable */
        button,
        button *,
        .btn,
        .btn *,
        .header h1,
        .logo h1,
        .settings-btn {
            font-size: 1rem !important;
        }
    </style>
</head>
<body>
    <!-- Accessibility Panel -->
    <div class="accessibility-panel hidden" id="accessibilityPanel">
        <h3>âš™ï¸ Accessibility Settings</h3>
        
        <div class="accessibility-section">
            <label>
                Font Size: <span class="font-size-display" id="fontSizeValue">16px</span>
            </label>
            <input type="range" id="fontSizeSlider" min="12" max="80" value="16" step="2"
                   oninput="updateFontSize(this.value)">
            <div class="range-labels">
                <span>Small (12px)</span>
                <span>Normal (16px)</span>
                <span>Large (40px)</span>
                <span>Huge (80px)</span>
            </div>
        </div>
        
        <div class="accessibility-section">
            <label>Theme</label>
            <select id="themeSelect" onchange="updateTheme(this.value)">
                <option value="light">â˜€ï¸ Light Mode</option>
                <option value="dark">ðŸŒ™ Dark Mode</option>
                <option value="highcontrast">â— High Contrast</option>
                <option value="dyslexia">ðŸ“– Dyslexia-Friendly</option>
            </select>
        </div>
        
        <div class="accessibility-section">
            <label>Line Spacing</label>
            <select id="lineSpacingSelect" onchange="updateLineSpacing(this.value)">
                <option value="1.4">Compact</option>
                <option value="1.6" selected>Normal</option>
                <option value="2.0">Relaxed</option>
                <option value="2.4">Extra Relaxed</option>
            </select>
        </div>

        <div class="accessibility-section">
            <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <span>Show Running Score</span>
                <input type="checkbox" id="runningScoreToggle" onchange="toggleRunningScore(this.checked)"
                       style="width: 20px; height: 20px; cursor: pointer;" checked>
            </label>
            <small style="color: var(--text-light); display: block; margin-top: 4px;">
                Display your current score during study sessions
            </small>
        </div>

        <div class="accessibility-section" style="border-top: 2px solid var(--border); padding-top: 20px; margin-top: 20px;">
            <label>Profile Settings</label>
            <div style="margin-bottom: 12px;">
                <input type="text" id="settingsUserName" placeholder="Enter your name (optional)"
                       style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); box-sizing: border-box;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="updateUserName()" style="flex: 1;">
                    Update Name
                </button>
                <button class="btn" onclick="clearUserName()" style="flex: 1; background: var(--bg);">
                    Go Anonymous
                </button>
            </div>
        </div>

        <button class="btn btn-primary" onclick="savePreferences()" style="width: 100%; margin-top: 12px;">
            ðŸ’¾ Save Preferences
        </button>
        
        <button class="btn" onclick="toggleAccessibility()" style="width: 100%; margin-top: 8px; background: var(--bg);">
            âœ–ï¸ Close
        </button>
    </div>
    
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">ðŸ“š</div>
                <div>
                    <h1>MFT Exam Master</h1>
                    <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">Your Personal Study Companion</p>
                </div>
            </div>
            <div class="user-info hidden" id="userInfo">
                <div class="user-avatar" id="userAvatar"></div>
                <div>
                    <div style="font-weight: 600;" id="userName"></div>
                    <div style="font-size: 0.85rem; color: var(--text-light);">Student</div>
                </div>
                <button class="settings-btn" id="accessibilityBtn" onclick="toggleAccessibility()" title="Settings">
                    âš™ï¸
                </button>
            </div>
        </div>

        <!-- Welcome Screen -->
        <div class="card welcome-screen" id="welcomeScreen">
            <div class="logo-icon" style="width: 80px; height: 80px; margin: 0 auto 20px; font-size: 40px;">ðŸ‘‹</div>
            <h2>Welcome to MFT Exam Master!</h2>
            <p>Your complete study companion for the Marriage and Family Therapy National Examination</p>
            
            <div style="max-width: 400px; margin: 0 auto;">
                <div class="input-group">
                    <label for="studentName">What's your name? (optional)</label>
                    <input type="text" id="studentName" placeholder="Enter your name (optional)" autofocus>
                </div>
                <button class="btn btn-primary" onclick="startStudying()" style="width: 100%;">
                    Let's Start Studying! ðŸš€
                </button>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="card hidden" id="dashboard">
            <h2>Choose Your Study Mode</h2>
            
            <div class="options-grid">
                <div class="option-card" onclick="selectMode('practice')">
                    <div class="icon">ðŸŽ¯</div>
                    <h3>Practice Mode</h3>
                    <p>Build confidence with instant feedback</p>
                </div>
                
                <div class="option-card" onclick="selectMode('exam')">
                    <div class="icon">ðŸ“</div>
                    <h3>Exam Simulation</h3>
                    <p>Test yourself like the real exam</p>
                </div>
                
                <div class="option-card" onclick="showSessionHistory()">
                    <div class="icon">ðŸ“š</div>
                    <h3>Review Past Sessions</h3>
                    <p>See all your test results and review missed questions</p>
                </div>
                
                <div class="option-card" onclick="showStudyNotes()">
                    <div class="icon">ðŸ“</div>
                    <h3>My Study Notes</h3>
                    <p>Review your personal notes on questions</p>
                </div>
                
                <div class="option-card" onclick="showReportCard()">
                    <div class="icon">ðŸ“Š</div>
                    <h3>Progress Report</h3>
                    <p>View your improvement over time</p>
                </div>
                
                <div class="option-card" onclick="showResources()">
                    <div class="icon">ðŸ”—</div>
                    <h3>Study Resources</h3>
                    <p>Helpful links and materials</p>
                </div>

                </div>

            <!-- Quick Stats -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--border);">
                <h3 style="margin-bottom: 15px;">Your Study Stats</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: var(--bg); border-radius: 12px;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary);" id="statTotalSessions">0</div>
                        <div style="font-size: 0.9rem; color: var(--text-light);">Total Sessions</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--bg); border-radius: 12px;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="statAvgScore">0%</div>
                        <div style="font-size: 0.9rem; color: var(--text-light);">Average Score</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--bg); border-radius: 12px;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="statFlaggedQuestions">0</div>
                        <div style="font-size: 0.9rem; color: var(--text-light);">Flagged Questions</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <a href="#" onclick="showFeedback(); return false;" style="color: var(--primary); font-size: 0.9rem; text-decoration: none; font-weight: 500;">
                        ðŸ’¬ Give Feedback
                    </a>
                </div>
            </div>
        </div>

        <!-- Study Settings -->
        <div class="card hidden" id="studySettings">
            <h2>Customize Your Study Session</h2>
            
            <div class="input-group">
                <label>Select Domains (Choose one or more)</label>
                <div class="checkbox-group" id="domainSelection"></div>
            </div>
            
            <div class="input-group">
                <label>Select Difficulty Level</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="diff_easy" value="easy" checked>
                        <label for="diff_easy">
                            <strong>Easy</strong> - Build confidence with foundational questions
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="diff_medium" value="medium" checked>
                        <label for="diff_medium">
                            <strong>Medium</strong> - Apply knowledge to scenarios
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="diff_hard" value="hard">
                        <label for="diff_hard">
                            <strong>Hard</strong> - Challenge yourself with complex cases
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <label for="questionCount">Number of Questions</label>
                <input type="number" id="questionCount" value="10" min="5" max="200">
                <small id="questionCountNote" style="display: none; color: var(--primary); margin-top: 5px;">ðŸ“ National MFT Exam format: 200 questions</small>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="startStudySession()">Start Session ðŸŽ¯</button>
                <button class="btn btn-secondary" onclick="backToDashboard()">Back</button>
            </div>

            <p id="freshQuestionsInfo" style="color: var(--text-light); font-size: 0.85rem; margin-top: 15px; text-align: center; padding: 10px; background: var(--bg); border-radius: 8px;"></p>
        </div>

        <!-- Study Session -->
        <div class="hidden" id="studySession">
            <!-- Progress Bar -->
            <div class="card" style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.9rem; color: var(--text-light); flex-wrap: wrap; gap: 10px;">
                    <span>Progress: <span id="sessionProgress">0/0</span></span>
                    <span id="runningScoreDisplay" style="font-weight: 600; padding: 4px 12px; border-radius: 20px; background: var(--primary-light); color: var(--primary);">
                        Score: <span id="runningScore">0%</span>
                    </span>
                    <span id="sessionTimer"></span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="sessionProgressBar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Question Display -->
            <div id="questionDisplay"></div>
            
            <!-- Navigation -->
            <div class="card" id="navigationCard">
                <h3 style="margin-bottom: 20px; color: var(--text-light); font-size: 1rem;">Ready to continue?</h3>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="previousQuestion()" id="prevBtn" style="flex: 1;">
                        â† Previous
                    </button>
                    <button class="btn skip-btn" onclick="skipQuestion()" id="skipBtn" style="flex: 1;">
                        Skip â†’
                    </button>
                    <button class="btn btn-primary" onclick="nextQuestion()" id="nextBtn" style="flex: 2; font-size: 1.1rem;">
                        Next Question â†’
                    </button>
                    <button class="btn btn-success" onclick="finishSession()" id="finishBtn" style="flex: 2; font-size: 1.1rem;">
                        ðŸ Finish & See Results
                    </button>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
                    <p style="text-align: center; color: var(--text-light); margin-bottom: 15px; font-size: 0.95rem;">
                        Or take a break:
                    </p>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="saveAndExit()" style="flex: 1;">
                            ðŸ’¾ Save & Exit
                        </button>
                        <button class="btn btn-danger" onclick="endSessionNow()" style="flex: 1;">
                            ðŸ›‘ End & Grade Now
                        </button>
                    </div>
                </div>
            </div>

            <!-- Exam Mode: Flagged Questions Summary -->
            <div id="flaggedSummary" class="card" style="display: none; background: #f3e8ff; border: 2px solid #9333ea;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <span style="color: #9333ea; font-weight: 600;">
                        ðŸš© <span id="flaggedCount">0</span> question(s) flagged for review
                    </span>
                    <button class="btn" onclick="jumpToNextFlagged()" style="background: #9333ea; color: white; padding: 8px 16px;">
                        Jump to Next Flagged â†’
                    </button>
                </div>
            </div>

            <!-- Question Navigator (Bottom - Full Width) -->
            <div class="question-palette" id="questionNavigator">
                <h3 style="font-size: 1.1rem; color: var(--text); margin-bottom: 15px;">
                    <span>ðŸ“‹ Click Any Question to Jump</span>
                    <button class="palette-toggle" onclick="toggleNavigator()">Hide</button>
                </h3>
                <div class="palette-legend" style="margin-bottom: 12px;">
                    <div class="legend-item"><div class="legend-dot current"></div> Current</div>
                    <div class="legend-item"><div class="legend-dot answered"></div> Answered</div>
                    <div class="legend-item"><div class="legend-dot unanswered"></div> Unanswered</div>
                    <div class="legend-item" id="flaggedLegend" style="display: none;"><div class="legend-dot" style="background: #f3e8ff; border: 1px solid #9333ea;"></div> Flagged</div>
                </div>
                <div class="palette-grid" id="questionPalette"></div>
            </div>

            <!-- Show Navigator Button (when hidden) -->
            <button class="btn btn-secondary show-navigator-btn" id="showNavigatorBtn" onclick="toggleNavigator()" style="display: none;">
                Show Question Navigator
            </button>
        </div>

        <!-- Results Screen -->
        <div class="card hidden" id="resultsScreen">
            <h2 style="text-align: center;">Session Complete! ðŸŽ‰</h2>
            
            <div class="score-circle passing" id="resultScore">
                <div>0%</div>
                <div class="score-label">SCORE</div>
            </div>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <h3 id="resultMessage"></h3>
                <p id="resultDetail"></p>
            </div>
            
            <div class="stats-grid" id="resultStats"></div>
            
            <div class="domain-performance">
                <h3>Performance by Domain</h3>
                <div id="domainResults"></div>
            </div>
            
            <div class="action-buttons" style="justify-content: center;">
                <button class="btn btn-primary" onclick="reviewSession(window.lastCompletedSessionId)">ðŸ“š Review All Questions</button>
                <button class="btn btn-warning" onclick="showMissedQuestions()">âŒ Review Missed Only</button>
                <button class="btn btn-success" onclick="backToDashboard()">Back to Dashboard</button>
                <button class="btn btn-secondary" onclick="exportResults()">ðŸ“„ Download Report</button>
            </div>
        </div>

        <!-- Missed Questions Review -->
        <div class="card hidden" id="missedQuestionsReview">
            <h2>Review: Questions You Missed</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">Study these explanations to improve your understanding</p>
            
            <div id="missedQuestionsList"></div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="backToResults()">Back to Results</button>
                <button class="btn btn-secondary" onclick="backToDashboard()">Dashboard</button>
            </div>
        </div>

        <!-- Session History Screen -->
        <div class="card hidden" id="sessionHistory">
            <h2>ðŸ“š Past Study Sessions</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">Review your test results and learn from missed questions</p>
            
            <div class="review-filters">
                <button class="filter-btn active" onclick="filterSessions('all')">All Sessions</button>
                <button class="filter-btn" onclick="filterSessions('passed')">âœ… Passed (â‰¥70%)</button>
                <button class="filter-btn" onclick="filterSessions('failed')">âŒ Need Review (<70%)</button>
            </div>
            
            <div id="sessionHistoryList">
                <div style="text-align: center; padding: 40px; color: var(--text-light);">
                    <div style="font-size: 3rem; margin-bottom: 16px;">ðŸ“š</div>
                    <p>No sessions yet. Complete your first practice session to see it here!</p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="backToDashboard()">Back to Dashboard</button>
            </div>
        </div>

        <!-- Session Review Screen -->
        <div class="card hidden" id="sessionReview">
            <h2>ðŸ“– Review Session</h2>
            <div id="sessionReviewHeader" style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--border);"></div>
            
            <div class="review-filters">
                <button class="filter-btn active" onclick="filterReviewQuestions('all')">All Questions</button>
                <button class="filter-btn" onclick="filterReviewQuestions('incorrect')">âŒ Incorrect</button>
                <button class="filter-btn" onclick="filterReviewQuestions('correct')">âœ… Correct</button>
                <button class="filter-btn" onclick="filterReviewQuestions('flagged')">ðŸš© Flagged</button>
            </div>
            
            <div id="reviewQuestionsList"></div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="showSessionHistory()">Back to History</button>
                <button class="btn btn-secondary" onclick="backToDashboard()">Dashboard</button>
            </div>
        </div>

        <!-- Study Notes Screen -->
        <div class="card hidden" id="studyNotes">
            <h2>ðŸ“ My Study Notes</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">All your personal notes on questions you've reviewed</p>
            
            <div id="studyNotesList">
                <div style="text-align: center; padding: 40px; color: var(--text-light);">
                    <div style="font-size: 3rem; margin-bottom: 16px;">ðŸ“</div>
                    <p>No notes yet. Add notes while reviewing questions to see them here!</p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="exportStudyNotes()">ðŸ“¥ Export Notes</button>
                <button class="btn btn-secondary" onclick="backToDashboard()">Back to Dashboard</button>
            </div>
        </div>

        <!-- Report Card -->
        <div class="card hidden" id="reportCard">
            <h2>ðŸ“Š Your Progress Report Card</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">ðŸŽ¯</div>
                    <div class="value" id="totalSessions">0</div>
                    <div class="label">Total Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="icon">âœ…</div>
                    <div class="value" id="totalQuestions">0</div>
                    <div class="label">Questions Answered</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ðŸ“ˆ</div>
                    <div class="value" id="averageScore">0%</div>
                    <div class="label">Average Score</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ðŸ”¥</div>
                    <div class="value" id="studyStreak">0</div>
                    <div class="label">Day Streak</div>
                </div>
            </div>
            
            <h3 style="margin-top: 30px; margin-bottom: 15px;">Recent Sessions</h3>
            <div id="sessionHistory"></div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="backToDashboard()">Back to Dashboard</button>
                <button class="btn btn-secondary" onclick="showSeenQuestions()">View Seen Questions</button>
                <button class="btn btn-warning" onclick="resetSeenQuestions()">Reset Seen Questions</button>
                <button class="btn btn-danger" onclick="resetProgress()">Reset All Progress</button>
            </div>
            <p style="color: var(--text-light); font-size: 0.85rem; margin-top: 10px; text-align: center;">
                Seen questions: <span id="seenQuestionsCount">0</span> / <span id="totalQuestionsCount">0</span>
                (Questions won't repeat until 80% have been seen)
            </p>
        </div>

        <!-- Seen Questions List -->
        <div class="card hidden" id="seenQuestionsScreen">
            <h2>Previously Seen Questions</h2>
            <p style="color: var(--text-light); margin-bottom: 15px;">Questions you've already answered (won't repeat until 80% of pool is seen)</p>

            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <label for="seenFilterDomain" style="color: var(--text-light);">Filter by domain:</label>
                <select id="seenFilterDomain" onchange="filterSeenQuestions()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border);">
                    <option value="all">All Domains</option>
                </select>
                <span id="seenFilterCount" style="color: var(--text-light); font-size: 0.9rem;"></span>
            </div>

            <div id="seenQuestionsList" style="max-height: 500px; overflow-y: auto;"></div>

            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="showSessionHistory()">Back to History</button>
                <button class="btn btn-secondary" onclick="backToDashboard()">Dashboard</button>
            </div>
        </div>

        <!-- Resources -->
        <div class="card hidden" id="resourcesScreen">
            <h2>ðŸ“š Study Resources & Links</h2>
            <p style="color: var(--text-light); margin-bottom: 30px;">Curated resources to supplement your study</p>
            
            <div class="resources-grid">
                <div class="resource-card">
                    <h3>AMFTRB Official</h3>
                    <p>Official exam information and candidate handbook</p>
                    <a href="https://amftrb.org" target="_blank" class="resource-link">Visit AMFTRB â†’</a>
                </div>
                
                <div class="resource-card">
                    <h3>AAMFT Code of Ethics</h3>
                    <p>Essential reading for ethical and professional standards</p>
                    <a href="https://aamft.org/Legal_Ethics/Code_of_Ethics.aspx" target="_blank" class="resource-link">Read Code of Ethics â†’</a>
                </div>
                
                <div class="resource-card">
                    <h3>DSM-5-TR Information</h3>
                    <p>Diagnostic criteria and mental health resources</p>
                    <a href="https://www.psychiatry.org/psychiatrists/practice/dsm" target="_blank" class="resource-link">Learn More â†’</a>
                </div>
                
                <div class="resource-card">
                    <h3>Family Therapy Basics</h3>
                    <p>Overview of major family therapy theories</p>
                    <a href="https://www.aamft.org/Consumer_Updates/Family_Therapy.aspx" target="_blank" class="resource-link">Explore Theories â†’</a>
                </div>
                
                <div class="resource-card">
                    <h3>Practice Exam (Official)</h3>
                    <p>AMFTRB's official practice examination</p>
                    <a href="https://amftrb.org/practice-exam/" target="_blank" class="resource-link">Take Practice Exam â†’</a>
                </div>
                
                <div class="resource-card">
                    <h3>State Licensing Boards</h3>
                    <p>Find your state's licensing requirements</p>
                    <a href="https://amftrb.org/resources/state-boards/" target="_blank" class="resource-link">Find Your State â†’</a>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="backToDashboard()">Back to Dashboard</button>
            </div>
        </div>

        <!-- Feedback Screen -->
        <div class="card hidden" id="feedbackScreen">
            <h2>ðŸ’¬ Give Feedback</h2>
            <p style="color: var(--text-light); margin-bottom: 30px;">Help us improve MFT Exam Master! Your feedback shapes this study tool.</p>

            <div style="display: grid; gap: 20px; max-width: 600px;">
                <!-- Feedback Type -->
                <div class="input-group">
                    <label for="feedbackType">What kind of feedback?</label>
                    <select id="feedbackType" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border);">
                        <option value="question">Question Issue (incorrect/unclear)</option>
                        <option value="suggestion">Suggestion for improvement</option>
                        <option value="bug">Bug or technical issue</option>
                        <option value="praise">What I love about this app</option>
                        <option value="other">Other feedback</option>
                    </select>
                </div>

                <!-- Question ID (optional) -->
                <div class="input-group">
                    <label for="feedbackQuestionId">Question ID (if applicable)</label>
                    <input type="number" id="feedbackQuestionId" placeholder="e.g., 101, 205, 312..."
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border);">
                    <small style="color: var(--text-light);">Find the question ID at the top of each question</small>
                </div>

                <!-- Feedback Text -->
                <div class="input-group">
                    <label for="feedbackText">Your Feedback</label>
                    <textarea id="feedbackText" rows="5" placeholder="Please describe the issue or suggestion in detail..."
                              style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border); resize: vertical;"></textarea>
                </div>

                <!-- Email (optional) -->
                <div class="input-group">
                    <label for="feedbackEmail">Your Email (optional)</label>
                    <input type="email" id="feedbackEmail" placeholder="For follow-up questions (not required)"
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border);">
                </div>

                <div class="action-buttons" style="margin-top: 10px;">
                    <button class="btn btn-primary" onclick="submitFeedback()">ðŸ“¤ Submit Feedback</button>
                    <button class="btn btn-secondary" onclick="backToDashboard()">Cancel</button>
                </div>
            </div>

            <!-- Previous Feedback -->
            <div id="previousFeedback" style="margin-top: 40px; padding-top: 20px; border-top: 2px solid var(--border);">
                <h3 style="margin-bottom: 15px;">Your Previous Feedback</h3>
                <div id="feedbackList"></div>
            </div>

            <!-- Question Stats for Admin -->
            <div id="questionStatsSection" style="margin-top: 40px; padding-top: 20px; border-top: 2px solid var(--border);">
                <h3 style="margin-bottom: 15px;">ðŸ“Š Your Question Statistics</h3>
                <p style="color: var(--text-light); margin-bottom: 15px;">Questions you've rated or may need review:</p>
                <div id="questionStatsList"></div>
            </div>
        </div>
    </div>

    <script>
        // Question Bank - loaded dynamically from JSON files
        let questionBank = [];
        
        // Load all question files
        async function loadAllQuestions() {
            const domainFiles = [
                'questions/domain1_systemic_therapy.json',
                'questions/domain2_assessment.json',
                'questions/domain3_treatment.json',
                'questions/domain4_evaluation.json',
                'questions/domain5_crisis.json',
                'questions/domain6_ethics.json',
                'questions/domain_moodle_import.json'
            ];
            
            try {
                console.log('ðŸ“š Loading questions...');
                const promises = domainFiles.map(file =>
                    fetch(file)
                        .then(response => {
                            if (!response.ok) throw new Error(`Failed to load ${file}`);
                            return response.json();
                        })
                        .catch(err => {
                            console.warn(`âš ï¸ Could not load ${file}:`, err.message);
                            return [];
                        })
                );
                
                const allDomains = await Promise.all(promises);
                questionBank = allDomains.flat();
                
                if (questionBank.length > 0) {
                    console.log(`âœ… Loaded ${questionBank.length} questions from domain files`);
                } else {
                    throw new Error('No questions loaded from domain files');
                }
            } catch (error) {
                console.error('âŒ Error loading domain files:', error);
                console.log('âš ï¸ Trying fallback: questions.json...');
                
                try {
                    const response = await fetch('questions.json');
                    if (!response.ok) throw new Error('questions.json not found');
                    questionBank = await response.json();
                    console.log(`âœ… Loaded ${questionBank.length} questions from questions.json`);
                } catch (fallbackError) {
                    console.error('âŒ Fallback also failed:', fallbackError);
                    questionBank = [];
                }
            }
            
            return questionBank;
        }

        // Domains configuration
        const domains = [
            { id: "domain1", name: "Practice of Systemic Therapy", description: "Systemic theories and therapeutic models" },
            { id: "domain2", name: "Assessing, Hypothesizing, Diagnosing", description: "Clinical assessment and diagnosis" },
            { id: "domain3", name: "Designing and Conducting Treatment", description: "Treatment planning and interventions" },
            { id: "domain4", name: "Evaluating Process and Terminating", description: "Progress monitoring and termination" },
            { id: "domain5", name: "Managing Crisis Situations", description: "Crisis intervention and safety" },
            { id: "domain6", name: "Ethical, Legal, Professional Standards", description: "Ethics, law, and professional practice" }
        ];

        // Domain default study URLs for further learning
        const domainDefaultUrls = {
            "Practice of Systemic Therapy": [
                { title: "AAMFT: Family Therapy Overview", url: "https://www.aamft.org/Consumer_Updates/Family_Therapy.aspx" },
                { title: "Bowen Center: Family Systems Theory", url: "https://www.thebowencenter.org/theory/" }
            ],
            "Assessing, Hypothesizing, Diagnosing": [
                { title: "APA: DSM-5 Resources", url: "https://www.psychiatry.org/psychiatrists/practice/dsm" },
                { title: "AAMFT: Assessment in Family Therapy", url: "https://www.aamft.org/" }
            ],
            "Designing and Conducting Treatment": [
                { title: "AAMFT: Treatment Planning", url: "https://www.aamft.org/" },
                { title: "AMFTRB: Clinical Resources", url: "https://amftrb.org/resources/" }
            ],
            "Evaluating Process and Terminating": [
                { title: "AMFTRB: Clinical Resources", url: "https://amftrb.org/resources/" }
            ],
            "Managing Crisis Situations": [
                { title: "988 Suicide & Crisis Lifeline", url: "https://988lifeline.org/" },
                { title: "SAMHSA: Crisis Resources", url: "https://www.samhsa.gov/find-help" }
            ],
            "Ethical, Legal, Professional Standards": [
                { title: "AAMFT Code of Ethics", url: "https://www.aamft.org/Legal_Ethics/Code_of_Ethics.aspx" },
                { title: "AMFTRB: Exam Resources", url: "https://amftrb.org/resources/" }
            ]
        };

        const globalDefaultUrl = [
            { title: "AMFTRB Study Resources", url: "https://amftrb.org/resources/" }
        ];

        // ===================================
        // GOOGLE FORMS CONFIGURATION
        // ===================================
        // To enable feedback collection via Google Forms:
        // 1. Create a Google Form with these fields:
        //    - Feedback Type (dropdown)
        //    - Question ID (short answer, number)
        //    - Feedback Text (paragraph)
        //    - Email (short answer, optional)
        //    - User ID (short answer)
        //    - Timestamp (short answer)
        // 2. Get your form's pre-filled link and extract the entry IDs
        // 3. Update the values below

        const GOOGLE_FORMS_CONFIG = {
            // === FEEDBACK FORM ===
            feedback: {
                enabled: false, // Set to true after configuring
                formUrl: 'https://docs.google.com/forms/d/e/YOUR_FEEDBACK_FORM_ID/formResponse',
                fields: {
                    feedbackType: 'entry.XXXXXXXXXX',    // Replace with your entry ID
                    questionId: 'entry.XXXXXXXXXX',      // Replace with your entry ID
                    feedbackText: 'entry.XXXXXXXXXX',    // Replace with your entry ID
                    email: 'entry.XXXXXXXXXX',           // Replace with your entry ID
                    userId: 'entry.XXXXXXXXXX',          // Replace with your entry ID
                    timestamp: 'entry.XXXXXXXXXX'        // Replace with your entry ID
                }
            },
            // === RATINGS FORM ===
            ratings: {
                enabled: false, // Set to true after configuring
                formUrl: 'https://docs.google.com/forms/d/e/YOUR_RATINGS_FORM_ID/formResponse',
                fields: {
                    questionId: 'entry.XXXXXXXXXX',      // Question ID number
                    rating: 'entry.XXXXXXXXXX',          // 'up' or 'down'
                    domain: 'entry.XXXXXXXXXX',          // Question domain
                    difficulty: 'entry.XXXXXXXXXX',      // easy/medium/hard
                    userId: 'entry.XXXXXXXXXX',          // Unique user ID
                    timestamp: 'entry.XXXXXXXXXX',       // When rated
                    wasCorrect: 'entry.XXXXXXXXXX'       // Did user answer correctly?
                }
            }
        };

        // Helper function to get study URLs for a question
        function getStudyUrls(question) {
            // If question has specific URLs, use them
            if (question.studyUrls && question.studyUrls.length > 0) {
                return question.studyUrls;
            }

            // Fall back to domain default
            const domainDefault = domainDefaultUrls[question.domain];
            if (domainDefault) {
                return domainDefault;
            }

            // Global fallback
            return globalDefaultUrl;
        }

        // Application State
        let state = {
            userName: '',
            studyMode: 'practice', // 'practice' or 'exam'
            preferences: {
                fontSize: 16,
                theme: 'light',
                lineSpacing: 1.6,
                showRunningScore: true
            },
            currentSession: {
                questions: [],
                currentIndex: 0,
                answers: {},
                startTime: null,
                selectedDomains: [],
                selectedDifficulty: [],
                questionDetails: [] // Store complete Q&A for review
            },
            sessions: [], // Complete history with all Q&A
            questionNotes: {}, // {questionId: {note: '', flagged: false}}
            questionRatings: {}, // {questionId: 'good' | 'irrelevant' | 'incorrect' | 'issue'}
            questionStats: {}, // {questionId: {timesAnswered, timesCorrect, good, irrelevant, incorrect, issue}}
            userFeedback: [], // [{date, questionId, type, comment}]
            seenQuestions: [], // Track question IDs that have been viewed (no repeat until 80% seen)
            history: [],
            stats: {
                totalSessions: 0,
                totalQuestions: 0,
                totalCorrect: 0,
                lastStudyDate: null,
                flaggedCount: 0
            },
            uniqueUserId: null // Generated on first use for analytics
        };

        // Initialize app
        async function init() {
            console.log('ðŸš€ Initializing MFT Exam Master...');
            
            // Load questions first
            await loadAllQuestions();
            
            if (questionBank.length === 0) {
                alert('âš ï¸ No questions loaded! Please check that question files exist.');
                console.error('No questions available');
            }
            
            loadUserData();
            loadPreferences(); // Load accessibility preferences
            updateDashboardStats(); // Update stats display
            
            if (state.userName) {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                updateUserInfo();
            }
            
            console.log('âœ… Initialization complete');
        }

        // Local Storage functions
        function loadUserData() {
            try {
                const saved = localStorage.getItem('mftExamMaster');
                if (saved) {
                    state = JSON.parse(saved);
                    // Migration: ensure required properties exist for existing users
                    if (!state.seenQuestions) {
                        state.seenQuestions = [];
                    }
                    if (!state.questionRatings) {
                        state.questionRatings = {};
                    }
                    if (!state.questionNotes) {
                        state.questionNotes = {};
                    }
                }
            } catch (e) {
                console.warn('Could not load saved data:', e.message);
                // Continue with default state
            }
        }

        function saveUserData() {
            try {
                localStorage.setItem('mftExamMaster', JSON.stringify(state));
            } catch (e) {
                console.warn('Could not save data (private browsing?):', e.message);
                // Silently fail - user can still use app, just won't persist
            }
        }

        // Debounced save for performance - waits 500ms after last call
        let saveTimeout = null;
        function debouncedSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveUserData();
            }, 500);
        }

        // Start studying
        function startStudying() {
            const name = document.getElementById('studentName').value.trim();

            state.userName = name; // Can be empty for anonymous users
            saveUserData();

            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            updateUserInfo();
        }

        function updateUserInfo() {
            const userInfoEl = document.getElementById('userInfo');
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.getElementById('userAvatar');

            userInfoEl.classList.remove('hidden');

            if (state.userName && state.userName.trim()) {
                // Show personalized greeting
                userNameEl.textContent = state.userName;
                userAvatarEl.textContent = state.userName.charAt(0).toUpperCase();
            } else {
                // Show anonymous/generic display
                userNameEl.textContent = 'Student';
                userAvatarEl.textContent = 'ðŸ‘¤';
            }
        }

        function updateUserName() {
            const newName = document.getElementById('settingsUserName').value.trim();
            state.userName = newName;
            saveUserData();
            updateUserInfo();
        }

        function clearUserName() {
            state.userName = '';
            document.getElementById('settingsUserName').value = '';
            saveUserData();
            updateUserInfo();
        }

        // Select study mode
        function selectMode(mode) {
            state.studyMode = mode;

            // Show study settings
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('studySettings').classList.remove('hidden');

            // Populate domain selection
            const domainSelection = document.getElementById('domainSelection');
            domainSelection.innerHTML = domains.map(domain => `
                <div class="checkbox-item">
                    <input type="checkbox" id="${domain.id}" value="${domain.name}" checked>
                    <label for="${domain.id}">
                        <strong>${domain.name}</strong><br>
                        <small>${domain.description}</small>
                    </label>
                </div>
            `).join('');

            // Handle exam mode - fixed at 200 questions like the national exam
            const questionCountInput = document.getElementById('questionCount');
            const questionCountNote = document.getElementById('questionCountNote');

            if (mode === 'exam') {
                questionCountInput.value = 200;
                questionCountInput.disabled = true;
                questionCountNote.style.display = 'block';
            } else {
                questionCountInput.value = 10;
                questionCountInput.disabled = false;
                questionCountNote.style.display = 'none';
            }

            // Show fresh questions info
            updateFreshQuestionsInfo();
        }

        function updateFreshQuestionsInfo() {
            const seenCount = (state.seenQuestions || []).length;
            const totalCount = questionBank.length;
            const freshCount = totalCount - seenCount;
            const freshPercent = totalCount > 0 ? Math.round((freshCount / totalCount) * 100) : 100;

            const infoEl = document.getElementById('freshQuestionsInfo');
            if (infoEl) {
                if (freshPercent >= 80) {
                    infoEl.innerHTML = `âœ¨ <strong>${freshCount}</strong> fresh questions available (${freshPercent}% of pool) â€” Questions won't repeat until 80% have been seen.`;
                } else if (freshPercent > 0) {
                    infoEl.innerHTML = `ðŸ“š <strong>${freshCount}</strong> fresh questions remaining (${freshPercent}%). Some previously seen questions may appear to ensure variety.`;
                } else {
                    infoEl.innerHTML = `ðŸ”„ All ${totalCount} questions have been seen! Questions will now cycle. <a href="#" onclick="resetSeenQuestions(); return false;">Reset seen questions</a>`;
                }
            }
        }

        // Start study session
        function startStudySession() {
            // Get selected domains
            const selectedDomains = Array.from(document.querySelectorAll('#domainSelection input:checked'))
                .map(cb => cb.value);
            
            if (selectedDomains.length === 0) {
                alert('Please select at least one domain!');
                return;
            }
            
            // Get selected difficulty
            const selectedDifficulty = [];
            if (document.getElementById('diff_easy').checked) selectedDifficulty.push('easy');
            if (document.getElementById('diff_medium').checked) selectedDifficulty.push('medium');
            if (document.getElementById('diff_hard').checked) selectedDifficulty.push('hard');
            
            if (selectedDifficulty.length === 0) {
                alert('Please select at least one difficulty level!');
                return;
            }
            
            const questionCount = parseInt(document.getElementById('questionCount').value);

            // Filter questions by domain and difficulty
            let matchingQuestions = questionBank.filter(q =>
                selectedDomains.includes(q.domain) &&
                selectedDifficulty.includes(q.difficulty)
            );

            if (matchingQuestions.length === 0) {
                alert('No questions match your criteria. Try different settings.');
                return;
            }

            // Separate unseen and seen questions (no repeat until 80% seen)
            const seenSet = new Set(state.seenQuestions || []);
            let unseenQuestions = matchingQuestions.filter(q => !seenSet.has(q.id));
            let seenQuestions = matchingQuestions.filter(q => seenSet.has(q.id));

            // Calculate if we've hit the 80% threshold for this question pool
            const seenPercentage = seenQuestions.length / matchingQuestions.length;
            const shouldRecycle = seenPercentage >= 0.8 || unseenQuestions.length < questionCount;

            // Shuffle function
            const shuffle = (arr) => {
                const shuffled = [...arr];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            };

            // Build question pool: prioritize unseen, add seen only if needed
            let filteredQuestions = [];
            if (shouldRecycle) {
                // Mix unseen first, then seen (shuffled)
                filteredQuestions = [...shuffle(unseenQuestions), ...shuffle(seenQuestions)];
            } else {
                // Only unseen questions (shuffled)
                filteredQuestions = shuffle(unseenQuestions);
            }

            // Limit to requested count
            filteredQuestions = filteredQuestions.slice(0, questionCount);

            // Show user info about question pool
            const unseenCount = unseenQuestions.length;
            const totalPool = matchingQuestions.length;
            console.log(`ðŸ“š Question pool: ${unseenCount}/${totalPool} unseen (${Math.round((1-seenPercentage)*100)}% fresh)`)
            
            // Initialize session
            state.currentSession = {
                questions: filteredQuestions,
                currentIndex: 0,
                answers: {},
                flaggedForReview: [], // Track question IDs marked for review (exam mode)
                startTime: Date.now(),
                selectedDomains: selectedDomains,
                selectedDifficulty: selectedDifficulty,
                mode: state.studyMode
            };

            // Reset palette state for new session
            resetPaletteState();

            // Show study session
            document.getElementById('studySettings').classList.add('hidden');
            document.getElementById('studySession').classList.remove('hidden');

            // Restore navigator visibility preference
            restoreNavigatorPreference();

            showQuestion();
        }

        // Show current question
        function showQuestion() {
            const session = state.currentSession;
            const question = session.questions[session.currentIndex];
            const isAnswered = session.answers[question.id] !== undefined;
            
            const display = document.getElementById('questionDisplay');
            display.innerHTML = `
                <div class="question-card">
                    <div class="question-header">
                        <div class="question-number">Question ${session.currentIndex + 1} of ${session.questions.length}</div>
                        <div class="difficulty-badge difficulty-${question.difficulty}">
                            ${question.difficulty.toUpperCase()}
                        </div>
                    </div>
                    
                    ${question.vignette ? `<div class="vignette">${question.vignette}</div>` : ''}
                    
                    <div class="question-text">${question.question}</div>
                    
                    <div class="answers">
                        ${question.options.map((opt, idx) => {
                            const isSelected = session.answers[question.id] === idx;
                            const showFeedback = state.studyMode === 'practice' && isAnswered;
                            const isCorrect = idx === question.correct;
                            
                            let classes = 'answer-option';
                            if (isSelected) classes += ' selected';
                            if (showFeedback) {
                                if (isCorrect) classes += ' correct';
                                else if (isSelected) classes += ' incorrect';
                            }
                            
                            return `
                                <div class="${classes}" onclick="selectAnswer(${idx})">
                                    <input type="radio"
                                           name="q${question.id}"
                                           id="q${question.id}_${idx}"
                                           ${isSelected ? 'checked' : ''}>
                                    <label for="q${question.id}_${idx}">
                                        ${String.fromCharCode(65 + idx)}) ${opt}
                                    </label>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    ${state.studyMode === 'exam' ? `
                        <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                            <button class="mark-review-btn ${(session.flaggedForReview || []).includes(question.id) ? 'flagged' : ''}"
                                    onclick="toggleFlagQuestion(${question.id})">
                                ${(session.flaggedForReview || []).includes(question.id) ? 'ðŸš© Flagged for Review' : 'ðŸ³ï¸ Mark for Review'}
                            </button>
                        </div>
                        ${!isAnswered ? `
                            <div style="text-align: center; margin-top: 15px; padding: 12px; background: var(--bg); border-radius: 8px; color: var(--text-light); font-size: 0.9rem;">
                                Select an answer, then use navigation below or the Question Navigator to continue.
                            </div>
                        ` : ''}
                    ` : ''}
                    
                    ${state.studyMode === 'practice' && isAnswered ? `
                        <div class="feedback ${session.answers[question.id] === question.correct ? 'correct' : 'incorrect'}">
                            <h4>${session.answers[question.id] === question.correct ? 'âœ… Correct!' : 'âŒ Incorrect'}</h4>
                            ${session.answers[question.id] !== question.correct ?
                                `<p><strong>Correct answer:</strong> ${String.fromCharCode(65 + question.correct)}) ${question.options[question.correct]}</p>` : ''}
                            <p><strong>Explanation:</strong> ${question.explanation}</p>
                            <div class="citation">
                                <strong>ðŸ“š Citation:</strong> ${question.citation}
                            </div>
                            <div class="study-links">
                                <strong>ðŸ”— Learn More:</strong>
                                ${getStudyUrls(question).map(link =>
                                    `<a href="${link.url}" target="_blank" rel="noopener noreferrer" class="study-link">${link.title} â†’</a>`
                                ).join('')}
                            </div>
                            ${question.memoryTip ? `
                            <div class="memory-tip">
                                <div class="memory-tip-header">
                                    <span>ðŸ’¡</span> Memory Tip
                                </div>
                                <div class="memory-tip-content">${question.memoryTip}</div>
                            </div>
                            ` : ''}
                            <div class="question-rating">
                                <span class="rating-label">Rate this question:</span>
                                <div class="rating-buttons">
                                    <button class="rating-btn rating-good ${state.questionRatings[question.id] === 'good' ? 'selected' : ''}"
                                            onclick="rateQuestion(${question.id}, 'good')" title="Good, helpful question">
                                        ðŸ‘ Good
                                    </button>
                                    <button class="rating-btn rating-irrelevant ${state.questionRatings[question.id] === 'irrelevant' ? 'selected' : ''}"
                                            onclick="rateQuestion(${question.id}, 'irrelevant')" title="Not relevant to MFT exam">
                                        âš ï¸ Irrelevant
                                    </button>
                                    <button class="rating-btn rating-incorrect ${state.questionRatings[question.id] === 'incorrect' ? 'selected' : ''}"
                                            onclick="rateQuestion(${question.id}, 'incorrect')" title="The marked answer is wrong">
                                        âŒ Wrong Answer
                                    </button>
                                    <button class="rating-btn rating-issue ${state.questionRatings[question.id] === 'issue' ? 'selected' : ''}"
                                            onclick="rateQuestion(${question.id}, 'issue')" title="Other issue with this question">
                                        ðŸ”§ Other Issue
                                    </button>
                                </div>
                                ${state.questionRatings[question.id] ? '<span class="rating-thanks">Thanks for your feedback!</span>' : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            updateSessionProgress();
            renderQuestionPalette();
            updateFlaggedSummary();
        }

        function selectAnswer(optionIndex) {
            const session = state.currentSession;
            const question = session.questions[session.currentIndex];

            // Check if this is the first time answering this question in this session
            const isFirstAnswer = session.answers[question.id] === undefined;

            // Save the answer but DON'T auto-advance
            session.answers[question.id] = optionIndex;

            // Track question statistics (only on first answer)
            if (isFirstAnswer) {
                const isCorrect = optionIndex === question.correct;
                trackQuestionAnswer(question.id, isCorrect);

                // Mark question as seen (for no-repeat-until-80% feature)
                if (!state.seenQuestions) state.seenQuestions = [];
                if (!state.seenQuestions.includes(question.id)) {
                    state.seenQuestions.push(question.id);
                }
            }

            saveUserData();

            // Just update the display to show selection and feedback (if practice mode)
            showQuestion();
        }

        // Throttle for skip/jump navigation only
        let navThrottle = false;

        function nextQuestion() {
            const session = state.currentSession;
            if (!session || !session.questions) return;

            const totalQuestions = session.questions.length;
            const answeredCount = Object.keys(session.answers).length;

            // If all questions answered, finish the session
            if (answeredCount >= totalQuestions) {
                finishSession();
                return;
            }

            // Find the lowest numbered unanswered question
            for (let i = 0; i < totalQuestions; i++) {
                const questionId = session.questions[i].id;
                if (session.answers[questionId] === undefined) {
                    session.currentIndex = i;
                    debouncedSave();
                    showQuestion();
                    window.scrollTo(0, 0);
                    return;
                }
            }

            // Fallback (shouldn't reach here if answeredCount is correct)
            finishSession();
        }

        function previousQuestion() {
            const session = state.currentSession;
            if (!session || !session.questions) return;

            if (session.currentIndex > 0) {
                session.currentIndex--;
            } else {
                // Wrap to end
                session.currentIndex = session.questions.length - 1;
            }

            debouncedSave();
            showQuestion();
            window.scrollTo(0, 0);
        }

        // Skip to next unanswered question
        function skipQuestion() {
            if (navThrottle) return;
            navThrottle = true;
            setTimeout(() => navThrottle = false, 100);

            const session = state.currentSession;
            if (!session || !session.questions) return;

            const totalQuestions = session.questions.length;
            const startIndex = session.currentIndex;

            // Find next unanswered question
            let nextIndex = (session.currentIndex + 1) % totalQuestions;

            while (nextIndex !== startIndex) {
                const questionId = session.questions[nextIndex].id;
                if (session.answers[questionId] === undefined) {
                    // Found an unanswered question
                    session.currentIndex = nextIndex;
                    debouncedSave();
                    showQuestion();
                    window.scrollTo(0, 0);
                    return;
                }
                nextIndex = (nextIndex + 1) % totalQuestions;
            }

            // All questions answered - go to finish
            finishSession();
        }

        // Jump to a specific question number
        function jumpToQuestion(index) {
            if (navThrottle) return;
            navThrottle = true;
            setTimeout(() => navThrottle = false, 100);

            const session = state.currentSession;
            if (!session || !session.questions) return;

            if (index >= 0 && index < session.questions.length) {
                session.currentIndex = index;
                debouncedSave();
                showQuestion();
                window.scrollTo(0, 0);
            }
        }

        // Toggle flag for review (exam mode)
        function toggleFlagQuestion(questionId) {
            const session = state.currentSession;
            if (!session.flaggedForReview) session.flaggedForReview = [];

            const idx = session.flaggedForReview.indexOf(questionId);
            if (idx === -1) {
                session.flaggedForReview.push(questionId);
            } else {
                session.flaggedForReview.splice(idx, 1);
            }

            saveUserData();
            showQuestion();
            renderQuestionPalette();
            updateFlaggedSummary();
        }

        // Update the flagged questions summary (exam mode)
        function updateFlaggedSummary() {
            const session = state.currentSession;
            const summary = document.getElementById('flaggedSummary');
            const countEl = document.getElementById('flaggedCount');

            if (!summary || !countEl) return;

            const flaggedCount = (session.flaggedForReview || []).length;

            if (state.studyMode === 'exam' && flaggedCount > 0) {
                summary.style.display = 'block';
                countEl.textContent = flaggedCount;
            } else {
                summary.style.display = 'none';
            }
        }

        // Jump to next flagged question (exam mode)
        function jumpToNextFlagged() {
            const session = state.currentSession;
            const flagged = session.flaggedForReview || [];

            if (flagged.length === 0) return;

            // Find the next flagged question after current index
            const currentIdx = session.currentIndex;
            let nextFlaggedIdx = -1;

            // First, look for flagged questions after current position
            for (let i = currentIdx + 1; i < session.questions.length; i++) {
                if (flagged.includes(session.questions[i].id)) {
                    nextFlaggedIdx = i;
                    break;
                }
            }

            // If not found, wrap around to beginning
            if (nextFlaggedIdx === -1) {
                for (let i = 0; i <= currentIdx; i++) {
                    if (flagged.includes(session.questions[i].id)) {
                        nextFlaggedIdx = i;
                        break;
                    }
                }
            }

            if (nextFlaggedIdx !== -1) {
                jumpToQuestion(nextFlaggedIdx);
            }
        }

        // Render the question palette grid with numbered buttons
        function renderQuestionPalette() {
            console.log('renderQuestionPalette called');

            const session = state.currentSession;
            const palette = document.getElementById('questionPalette');
            const flaggedLegend = document.getElementById('flaggedLegend');

            if (!palette) {
                console.error('ERROR: Question palette element not found!');
                return;
            }

            if (!session || !session.questions || session.questions.length === 0) {
                console.error('ERROR: No questions in session!', session);
                palette.innerHTML = '<div style="color: red; padding: 20px;">No questions loaded</div>';
                return;
            }

            console.log('Rendering palette with', session.questions.length, 'questions');

            // Show flagged legend in exam mode
            if (flaggedLegend) {
                flaggedLegend.style.display = state.studyMode === 'exam' ? 'flex' : 'none';
            }

            const flaggedSet = new Set(session.flaggedForReview || []);

            // Build the palette HTML
            let html = '';
            for (let idx = 0; idx < session.questions.length; idx++) {
                const q = session.questions[idx];
                const isAnswered = session.answers[q.id] !== undefined;
                const isCurrent = idx === session.currentIndex;
                const isFlagged = flaggedSet.has(q.id);

                let classes = 'palette-item';
                if (isCurrent) classes += ' current';
                if (isAnswered) classes += ' answered';
                if (isFlagged) classes += ' flagged';

                const title = `Question ${idx + 1}${isAnswered ? ' (Answered)' : ' (Unanswered)'}${isFlagged ? ' - Flagged' : ''}`;
                html += `<div class="${classes}" onclick="jumpToQuestion(${idx})" title="${title}">${idx + 1}</div>`;
            }

            palette.innerHTML = html;
            console.log('Palette rendered, innerHTML length:', palette.innerHTML.length);
        }

        // Reset palette state when starting new session (kept for compatibility)
        function resetPaletteState() {
            const palette = document.getElementById('questionPalette');
            if (palette) palette.innerHTML = '';
        }

        // Toggle navigator visibility (complete hide/show)
        function toggleNavigator() {
            const navigator = document.getElementById('questionNavigator');
            const showBtn = document.getElementById('showNavigatorBtn');

            if (!navigator || !showBtn) return;

            const isHidden = navigator.classList.toggle('navigator-hidden');
            showBtn.style.display = isHidden ? 'block' : 'none';

            // Update button text
            const toggleBtn = navigator.querySelector('.palette-toggle');
            if (toggleBtn) {
                toggleBtn.textContent = 'Hide Navigator';
            }

            // Save preference
            localStorage.setItem('mft_navigator_hidden', isHidden ? 'true' : 'false');
        }

        // Restore navigator preference on session start
        function restoreNavigatorPreference() {
            const navigator = document.getElementById('questionNavigator');
            const showBtn = document.getElementById('showNavigatorBtn');

            // Always show navigator in exam mode for full navigation ability
            if (state.studyMode === 'exam') {
                if (navigator) navigator.classList.remove('navigator-hidden');
                if (showBtn) showBtn.style.display = 'none';
                return;
            }

            // For practice mode, respect user preference
            const isHidden = localStorage.getItem('mft_navigator_hidden') === 'true';
            if (navigator && showBtn && isHidden) {
                navigator.classList.add('navigator-hidden');
                showBtn.style.display = 'block';
            }
        }

        function updateSessionProgress() {
            const session = state.currentSession;
            const answered = Object.keys(session.answers).length;
            const total = session.questions.length;
            const progress = (answered / total) * 100;

            document.getElementById('sessionProgress').textContent = `${answered}/${total}`;
            document.getElementById('sessionProgressBar').style.width = `${progress}%`;

            // Update running score
            updateRunningScore();

            // Update timer
            if (session.startTime) {
                const elapsed = Math.floor((Date.now() - session.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('sessionTimer').textContent =
                    `Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // Update button visibility and states
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const skipBtn = document.getElementById('skipBtn');
            const finishBtn = document.getElementById('finishBtn');

            // Previous button - always enabled (wraps around)
            prevBtn.disabled = false;
            prevBtn.style.opacity = '1';
            prevBtn.style.cursor = 'pointer';

            // Always show Next and Skip buttons (Next wraps around and finishes when all answered)
            nextBtn.style.display = 'inline-flex';
            skipBtn.style.display = 'inline-flex';

            // Show Finish button when all questions are answered (as alternative to Next)
            const answeredCount = Object.keys(session.answers).length;
            if (answeredCount >= session.questions.length) {
                finishBtn.style.display = 'inline-flex';
            } else {
                finishBtn.style.display = 'none';
            }
        }

        function saveAndExit() {
            const session = state.currentSession;
            const answered = Object.keys(session.answers).length;
            
            if (confirm(`ðŸ’¾ Your progress is saved!\n\nYou've answered ${answered} of ${session.questions.length} questions.\n\nReturn to dashboard?`)) {
                document.getElementById('studySession').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                window.scrollTo(0, 0);
            }
        }
        
        function endSessionNow() {
            const session = state.currentSession;
            const answered = Object.keys(session.answers).length;
            
            if (answered === 0) {
                alert('âš ï¸ You haven\'t answered any questions yet!');
                return;
            }
            
            const message = answered < session.questions.length
                ? `ðŸ›‘ You've answered ${answered} of ${session.questions.length} questions.\n\nYou'll be graded only on the questions you answered.\n\nEnd session now and see results?`
                : `ðŸŽ‰ You've answered all ${answered} questions!\n\nReady to see your results?`;
            
            if (confirm(message)) {
                calculateResults();
            }
        }

        function pauseSession() {
            if (confirm('Your progress is automatically saved. Return to dashboard?')) {
                document.getElementById('studySession').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
            }
        }

        function finishSession() {
            const session = state.currentSession;
            const answered = Object.keys(session.answers).length;
            
            if (answered < session.questions.length) {
                if (!confirm(`You've answered ${answered} of ${session.questions.length} questions. Finish anyway?`)) {
                    return;
                }
            }
            
            calculateResults();
        }

        function calculateResults() {
            const session = state.currentSession;
            let correct = 0;
            const domainScores = {};
            
            session.questions.forEach(question => {
                const domain = question.domain;
                if (!domainScores[domain]) {
                    domainScores[domain] = { correct: 0, total: 0, answered: 0 };
                }
                domainScores[domain].total++;
                
                if (session.answers[question.id] !== undefined) {
                    domainScores[domain].answered++;
                    if (session.answers[question.id] === question.correct) {
                        correct++;
                        domainScores[domain].correct++;
                    }
                }
            });
            
            const answered = Object.keys(session.answers).length;
            const percentage = answered > 0 ? Math.round((correct / answered) * 100) : 0;
            const passing = percentage >= 70;
            
            // Save to history
            const sessionResult = {
                date: new Date().toISOString(),
                score: percentage,
                correct: correct,
                total: answered,
                mode: session.mode,
                domains: session.selectedDomains,
                difficulty: session.selectedDifficulty,
                domainScores: domainScores
            };
            
            // ENHANCED: Save complete session with all Q&A for review
            const endTime = Date.now();
            const duration = Math.floor((endTime - session.startTime) / 1000);
            
            const completeSession = {
                id: 'session_' + Date.now(),
                date: new Date().toISOString(),
                mode: state.studyMode,
                domains: session.selectedDomains,
                difficulty: session.selectedDifficulty,
                questions: session.questions.map(q => ({
                    questionId: q.id,
                    questionText: q.question,
                    vignette: q.vignette || '',
                    options: q.options,
                    userAnswer: session.answers[q.id],
                    correctAnswer: q.correct,
                    isCorrect: session.answers[q.id] === q.correct,
                    explanation: q.explanation,
                    citation: q.citation,
                    domain: q.domain,
                    difficulty: q.difficulty,
                    studyUrls: q.studyUrls || null,
                    memoryTip: q.memoryTip || null,
                    timeSpent: 0 // Could track per question if needed
                })),
                score: percentage,
                correct: correct,
                total: answered,
                duration: duration
            };
            
            // Save to enhanced sessions array
            if (!state.sessions) state.sessions = [];
            state.sessions.push(completeSession);
            
            state.history.push(sessionResult);
            state.stats.totalSessions++;
            state.stats.totalQuestions += answered;
            state.stats.totalCorrect += correct;
            state.stats.lastStudyDate = new Date().toISOString();
            
            saveUserData();
            updateDashboardStats();
            
            // Show results with review button
            showResults(sessionResult, passing, completeSession.id);
        }

        function showResults(result, passing, sessionId) {
            document.getElementById('studySession').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            // Store sessionId for review button
            window.lastCompletedSessionId = sessionId;
            
            // Score circle
            const scoreCircle = document.getElementById('resultScore');
            scoreCircle.className = `score-circle ${passing ? 'passing' : 'failing'}`;
            scoreCircle.querySelector('div').textContent = `${result.score}%`;
            
            // Message
            const messages = {
                90: { title: "ðŸŒŸ Outstanding!", msg: "You're crushing it! Excellent mastery of the material." },
                80: { title: "ðŸŽ‰ Great Job!", msg: "Strong performance! You're well-prepared." },
                70: { title: "âœ… Good Work!", msg: "Passing score. Keep studying to strengthen weak areas." },
                0: { title: "ðŸ“š Keep Studying", msg: "More practice needed. Review the explanations carefully." }
            };
            
            const msgKey = result.score >= 90 ? 90 : result.score >= 80 ? 80 : result.score >= 70 ? 70 : 0;
            document.getElementById('resultMessage').textContent = messages[msgKey].title;
            document.getElementById('resultDetail').textContent = messages[msgKey].msg;
            
            // Stats
            document.getElementById('resultStats').innerHTML = `
                <div class="stat-card">
                    <div class="icon">âœ…</div>
                    <div class="value">${result.correct}</div>
                    <div class="label">Correct</div>
                </div>
                <div class="stat-card">
                    <div class="icon">âŒ</div>
                    <div class="value">${result.total - result.correct}</div>
                    <div class="label">Incorrect</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ðŸ“</div>
                    <div class="value">${result.total}</div>
                    <div class="label">Answered</div>
                </div>
            `;
            
            // Domain results
            const domainHtml = Object.entries(result.domainScores).map(([domain, scores]) => {
                const percentage = scores.answered > 0 ? Math.round((scores.correct / scores.answered) * 100) : 0;
                return `
                    <div class="domain-row">
                        <div class="domain-name">${domain}</div>
                        <div class="domain-score">
                            <div class="domain-bar">
                                <div class="domain-bar-fill" style="width: ${percentage}%"></div>
                            </div>
                            <strong>${scores.correct}/${scores.answered} (${percentage}%)</strong>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('domainResults').innerHTML = domainHtml;
            
            window.scrollTo(0, 0);
        }

        function showMissedQuestions() {
            const session = state.currentSession;
            const missed = session.questions.filter(q =>
                session.answers[q.id] !== undefined &&
                session.answers[q.id] !== q.correct
            );
            
            if (missed.length === 0) {
                alert('ðŸŽ‰ Amazing! You didn\'t miss any questions!');
                return;
            }
            
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('missedQuestionsReview').classList.remove('hidden');
            
            const missedHtml = missed.map((question, index) => {
                const userAnswer = session.answers[question.id];
                return `
                    <div class="question-card" style="border-left-color: var(--danger);">
                        <div class="question-header">
                            <div class="question-number">Question ${index + 1} of ${missed.length}</div>
                            <div class="difficulty-badge difficulty-${question.difficulty}">
                                ${question.difficulty.toUpperCase()}
                            </div>
                        </div>
                        
                        ${question.vignette ? `<div class="vignette">${question.vignette}</div>` : ''}
                        
                        <div class="question-text">${question.question}</div>
                        
                        <div style="background: var(--danger-light); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <strong>âŒ Your Answer:</strong> ${String.fromCharCode(65 + userAnswer)}) ${question.options[userAnswer]}
                        </div>
                        
                        <div style="background: var(--success-light); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <strong>âœ… Correct Answer:</strong> ${String.fromCharCode(65 + question.correct)}) ${question.options[question.correct]}
                        </div>
                        
                        <div class="feedback correct">
                            <h4>ðŸ“– Explanation</h4>
                            <p>${question.explanation}</p>
                            <div class="citation">
                                <strong>ðŸ“š Citation:</strong> ${question.citation}
                            </div>
                            <div class="study-links">
                                <strong>ðŸ”— Learn More:</strong>
                                ${getStudyUrls(question).map(link =>
                                    `<a href="${link.url}" target="_blank" rel="noopener noreferrer" class="study-link">${link.title} â†’</a>`
                                ).join('')}
                            </div>
                            ${question.memoryTip ? `
                            <div class="memory-tip">
                                <div class="memory-tip-header">
                                    <span>ðŸ’¡</span> Memory Tip
                                </div>
                                <div class="memory-tip-content">${question.memoryTip}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('missedQuestionsList').innerHTML = missedHtml;
            window.scrollTo(0, 0);
        }

        function backToResults() {
            document.getElementById('missedQuestionsReview').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
        }

        function showReportCard() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('reportCard').classList.remove('hidden');
            
            // Calculate stats
            const avgScore = state.stats.totalQuestions > 0 ?
                Math.round((state.stats.totalCorrect / state.stats.totalQuestions) * 100) : 0;
            
            document.getElementById('totalSessions').textContent = state.stats.totalSessions;
            document.getElementById('totalQuestions').textContent = state.stats.totalQuestions;
            document.getElementById('averageScore').textContent = avgScore + '%';
            document.getElementById('studyStreak').textContent = calculateStreak();
            
            // Show history
            const historyHtml = state.history.slice(-10).reverse().map(session => {
                const date = new Date(session.date);
                return `
                    <div class="history-item">
                        <div>
                            <div style="font-weight: 600;">${session.mode === 'practice' ? 'ðŸŽ¯ Practice' : 'ðŸ“ Exam'} Session</div>
                            <div class="history-date">${date.toLocaleDateString()} at ${date.toLocaleTimeString()}</div>
                            <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 5px;">
                                ${session.correct}/${session.total} questions correct
                            </div>
                        </div>
                        <div class="history-score">${session.score}%</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('sessionHistory').innerHTML = historyHtml ||
                '<p style="text-align: center; color: var(--text-light); padding: 20px;">No sessions yet. Start studying to see your progress!</p>';
            
            window.scrollTo(0, 0);
        }

        function calculateStreak() {
            if (!state.stats.lastStudyDate) return 0;
            
            const today = new Date();
            const lastStudy = new Date(state.stats.lastStudyDate);
            const diffDays = Math.floor((today - lastStudy) / (1000 * 60 * 60 * 24));
            
            return diffDays <= 1 ? state.stats.totalSessions : 0;
        }

        function showResources() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('resourcesScreen').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function showFeedback() {
            hideAllScreens();
            document.getElementById('feedbackScreen').classList.remove('hidden');
            renderPreviousFeedback();
            renderQuestionStats();
            window.scrollTo(0, 0);
        }

        function submitFeedback() {
            const type = document.getElementById('feedbackType').value;
            const questionId = document.getElementById('feedbackQuestionId').value;
            const text = document.getElementById('feedbackText').value.trim();
            const email = document.getElementById('feedbackEmail').value.trim();

            if (!text) {
                alert('Please enter your feedback before submitting.');
                return;
            }

            // Initialize feedback array if needed
            if (!state.userFeedback) state.userFeedback = [];

            // Create feedback object
            const feedback = {
                id: 'feedback_' + Date.now(),
                date: new Date().toISOString(),
                type: type,
                questionId: questionId ? parseInt(questionId) : null,
                text: text,
                email: email || null,
                userId: generateUniqueUserId()
            };

            // Save locally
            state.userFeedback.push(feedback);
            saveUserData();

            // Send to Google Forms if configured
            if (GOOGLE_FORMS_CONFIG.feedback.enabled) {
                sendFeedbackToGoogleForms(feedback);
            }

            // Clear form
            document.getElementById('feedbackText').value = '';
            document.getElementById('feedbackQuestionId').value = '';
            document.getElementById('feedbackEmail').value = '';

            // Show confirmation
            alert('Thank you for your feedback! Your input helps improve this study tool.');

            // Re-render feedback list
            renderPreviousFeedback();

            // Log for analytics
            console.log('Feedback submitted:', feedback);
        }

        function sendFeedbackToGoogleForms(feedback) {
            const config = GOOGLE_FORMS_CONFIG.feedback;
            const params = new URLSearchParams();
            params.append(config.fields.feedbackType, feedback.type);
            params.append(config.fields.questionId, feedback.questionId || '');
            params.append(config.fields.feedbackText, feedback.text);
            params.append(config.fields.email, feedback.email || '');
            params.append(config.fields.userId, feedback.userId);
            params.append(config.fields.timestamp, feedback.date);

            submitToGoogleForm(config.formUrl, params);
            console.log('Feedback sent to Google Forms');
        }

        function sendRatingToGoogleForms(questionId, rating, question, wasCorrect) {
            if (!GOOGLE_FORMS_CONFIG.ratings.enabled) return;

            const config = GOOGLE_FORMS_CONFIG.ratings;
            const params = new URLSearchParams();
            params.append(config.fields.questionId, questionId);
            params.append(config.fields.rating, rating);
            params.append(config.fields.domain, question?.domain || 'Unknown');
            params.append(config.fields.difficulty, question?.difficulty || 'Unknown');
            params.append(config.fields.userId, generateUniqueUserId());
            params.append(config.fields.timestamp, new Date().toISOString());
            params.append(config.fields.wasCorrect, wasCorrect ? 'Yes' : 'No');

            submitToGoogleForm(config.formUrl, params);
            console.log('Rating sent to Google Forms:', { questionId, rating });
        }

        function submitToGoogleForm(formUrl, params) {
            // Submit via hidden iframe (avoids CORS issues)
            const iframeName = 'google_forms_iframe_' + Date.now();
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.name = iframeName;
            document.body.appendChild(iframe);

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = formUrl;
            form.target = iframeName;

            // Add all params as hidden inputs
            for (const [key, value] of params.entries()) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }

            document.body.appendChild(form);
            form.submit();

            // Clean up after submission
            setTimeout(() => {
                if (document.body.contains(form)) document.body.removeChild(form);
                if (document.body.contains(iframe)) document.body.removeChild(iframe);
            }, 2000);
        }

        function renderPreviousFeedback() {
            const container = document.getElementById('feedbackList');
            if (!state.userFeedback || state.userFeedback.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No feedback submitted yet.</p>';
                return;
            }

            const feedbackHtml = state.userFeedback.slice().reverse().slice(0, 10).map(fb => {
                const date = new Date(fb.date).toLocaleDateString();
                const typeLabels = {
                    question: 'â“ Question Issue',
                    suggestion: 'ðŸ’¡ Suggestion',
                    bug: 'ðŸ› Bug Report',
                    praise: 'â¤ï¸ Praise',
                    other: 'ðŸ“ Other'
                };
                return `
                    <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600;">${typeLabels[fb.type] || fb.type}</span>
                            <span style="color: var(--text-light); font-size: 0.85rem;">${date}</span>
                        </div>
                        ${fb.questionId ? `<div style="font-size: 0.85rem; color: var(--primary); margin-bottom: 8px;">Question #${fb.questionId}</div>` : ''}
                        <div style="color: var(--text);">${fb.text}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = feedbackHtml;
        }

        function renderQuestionStats() {
            const container = document.getElementById('questionStatsList');

            // Get rated questions by type
            const ratedQuestions = { good: [], irrelevant: [], incorrect: [], issue: [] };
            if (state.questionRatings) {
                for (const qId in state.questionRatings) {
                    const rating = state.questionRatings[qId];
                    if (ratedQuestions[rating]) {
                        ratedQuestions[rating].push(parseInt(qId));
                    }
                }
            }

            const totalRated = Object.values(ratedQuestions).flat().length;

            if (totalRated === 0) {
                container.innerHTML = '<p style="color: var(--text-light); font-style: italic;">Answer and rate more questions to see statistics.</p>';
                return;
            }

            let html = '';

            // Show incorrect answer questions (highest priority)
            if (ratedQuestions.incorrect.length > 0) {
                html += '<h4 style="color: var(--danger); margin-bottom: 10px;">âŒ Questions With Wrong Answers (' + ratedQuestions.incorrect.length + ')</h4>';
                html += '<div style="display: grid; gap: 10px; margin-bottom: 20px;">';
                ratedQuestions.incorrect.forEach(qId => {
                    html += `
                        <div style="background: var(--danger-light); padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <span><strong>Question #${qId}</strong> - Marked answer may be incorrect</span>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;" onclick="reportQuestion(${qId})">
                                Report Details
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Show irrelevant questions
            if (ratedQuestions.irrelevant.length > 0) {
                html += '<h4 style="color: #b45309; margin-bottom: 10px;">âš ï¸ Irrelevant Questions (' + ratedQuestions.irrelevant.length + ')</h4>';
                html += '<div style="display: grid; gap: 10px; margin-bottom: 20px;">';
                ratedQuestions.irrelevant.forEach(qId => {
                    html += `
                        <div style="background: var(--warning-light); padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <span><strong>Question #${qId}</strong> - May not be relevant to MFT exam</span>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;" onclick="reportQuestion(${qId})">
                                Report Details
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Show other issues
            if (ratedQuestions.issue.length > 0) {
                html += '<h4 style="color: var(--purple); margin-bottom: 10px;">ðŸ”§ Other Issues (' + ratedQuestions.issue.length + ')</h4>';
                html += '<div style="display: grid; gap: 10px; margin-bottom: 20px;">';
                ratedQuestions.issue.forEach(qId => {
                    html += `
                        <div style="background: var(--purple-light); padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <span><strong>Question #${qId}</strong></span>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;" onclick="reportQuestion(${qId})">
                                Report Details
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Show good questions count
            if (ratedQuestions.good.length > 0) {
                html += '<h4 style="color: var(--success); margin-bottom: 10px;">ðŸ‘ Good Questions (' + ratedQuestions.good.length + ')</h4>';
                html += '<p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 15px;">These questions are working well for you!</p>';
            }

            // Show overall stats
            html += `
                <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">ðŸ“ˆ Your Rating Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                        <div style="text-align: center; padding: 10px; background: var(--success-light); border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--success);">${ratedQuestions.good.length}</div>
                            <div style="font-size: 0.75rem; color: var(--text-light);">Good</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--warning-light); border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: 700; color: #b45309;">${ratedQuestions.irrelevant.length}</div>
                            <div style="font-size: 0.75rem; color: var(--text-light);">Irrelevant</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--danger-light); border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--danger);">${ratedQuestions.incorrect.length}</div>
                            <div style="font-size: 0.75rem; color: var(--text-light);">Wrong Answer</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--purple-light); border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--purple);">${ratedQuestions.issue.length}</div>
                            <div style="font-size: 0.75rem; color: var(--text-light);">Other</div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function reportQuestion(questionId) {
            document.getElementById('feedbackType').value = 'question';
            document.getElementById('feedbackQuestionId').value = questionId;
            document.getElementById('feedbackText').focus();
            window.scrollTo(0, 0);
        }

        // Utility function to hide all screens
        function hideAllScreens() {
            document.querySelectorAll('.card, #studySession, #sessionHistory, #sessionReview, #studyNotesScreen, #seenQuestionsScreen').forEach(el => {
                el.classList.add('hidden');
            });
        }

        function backToDashboard() {
            // Hide all screens
            hideAllScreens();
            
            // Show dashboard
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Reset current session if coming from study
            state.currentSession = {
                questions: [],
                currentIndex: 0,
                answers: {},
                startTime: null,
                selectedDomains: [],
                selectedDifficulty: []
            };
            saveUserData();
            
            window.scrollTo(0, 0);
        }

        function exportResults() {
            const report = generateTextReport();
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MFT_Progress_Report_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
        }

        function generateTextReport() {
            let report = `MFT EXAM MASTER - PROGRESS REPORT
Student: ${state.userName}
Generated: ${new Date().toLocaleString()}

========================================
OVERALL STATISTICS
========================================
Total Study Sessions: ${state.stats.totalSessions}
Total Questions Answered: ${state.stats.totalQuestions}
Total Correct Answers: ${state.stats.totalCorrect}
Overall Average Score: ${state.stats.totalQuestions > 0 ? Math.round((state.stats.totalCorrect / state.stats.totalQuestions) * 100) : 0}%

========================================
RECENT SESSIONS
========================================
`;
            
            state.history.slice(-10).reverse().forEach((session, idx) => {
                const date = new Date(session.date);
                report += `\n${idx + 1}. ${session.mode.toUpperCase()} Session - ${date.toLocaleDateString()}
   Score: ${session.score}% (${session.correct}/${session.total} correct)
   Domains: ${session.domains.join(', ')}
   Difficulty: ${session.difficulty.join(', ')}\n`;
            });
            
            report += `\n========================================
Keep up the great work studying!
Visit https://amftrb.org for official exam info.
========================================`;
            
            return report;
        }

        function resetProgress() {
            if (confirm('âš ï¸ This will delete ALL your progress and cannot be undone. Are you sure?')) {
                if (confirm('Really sure? This action is permanent!')) {
                    const name = state.userName;
                    state = {
                        userName: name,
                        studyMode: 'practice',
                        currentSession: {
                            questions: [],
                            currentIndex: 0,
                            answers: {},
                            startTime: null,
                            selectedDomains: [],
                            selectedDifficulty: []
                        },
                        seenQuestions: [],
                        history: [],
                        stats: {
                            totalSessions: 0,
                            totalQuestions: 0,
                            totalCorrect: 0,
                            lastStudyDate: null
                        }
                    };
                    saveUserData();
                    alert('âœ… Progress reset successfully!');
                    backToDashboard();
                }
            }
        }

        function resetSeenQuestions() {
            const seenCount = (state.seenQuestions || []).length;
            if (seenCount === 0) {
                alert('No seen questions to reset!');
                return;
            }
            if (confirm(`Reset ${seenCount} seen questions? This will allow all questions to appear again as "fresh" questions.`)) {
                state.seenQuestions = [];
                saveUserData();
                updateSeenQuestionsDisplay();
                alert('âœ… Seen questions reset! All questions will now appear as fresh.');
            }
        }

        function updateSeenQuestionsDisplay() {
            const seenCount = document.getElementById('seenQuestionsCount');
            const totalCount = document.getElementById('totalQuestionsCount');
            if (seenCount && totalCount) {
                seenCount.textContent = (state.seenQuestions || []).length;
                totalCount.textContent = questionBank.length;
            }
        }

        function showSeenQuestions() {
            hideAllScreens();
            document.getElementById('seenQuestionsScreen').classList.remove('hidden');

            // Populate domain filter dropdown
            const domainSelect = document.getElementById('seenFilterDomain');
            const uniqueDomains = [...new Set(questionBank.map(q => q.domain))];
            domainSelect.innerHTML = '<option value="all">All Domains</option>' +
                uniqueDomains.map(d => `<option value="${d}">${d}</option>`).join('');

            // Render the list
            filterSeenQuestions();
        }

        function filterSeenQuestions() {
            const selectedDomain = document.getElementById('seenFilterDomain').value;
            const seenSet = new Set(state.seenQuestions || []);

            // Get seen questions from question bank
            let seenQuestionsList = questionBank.filter(q => seenSet.has(q.id));

            // Apply domain filter
            if (selectedDomain !== 'all') {
                seenQuestionsList = seenQuestionsList.filter(q => q.domain === selectedDomain);
            }

            // Sort by ID
            seenQuestionsList.sort((a, b) => a.id - b.id);

            // Update count display
            const countEl = document.getElementById('seenFilterCount');
            countEl.textContent = `Showing ${seenQuestionsList.length} question${seenQuestionsList.length !== 1 ? 's' : ''}`;

            // Render the list
            const listEl = document.getElementById('seenQuestionsList');

            if (seenQuestionsList.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <p style="font-size: 1.2rem;">No seen questions yet!</p>
                        <p>Start a study session to begin tracking your progress.</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = seenQuestionsList.map(q => {
                // Get stats for this question if available
                const stats = state.questionStats?.[q.id];
                const timesAnswered = stats?.timesAnswered || 0;
                const timesCorrect = stats?.timesCorrect || 0;
                const accuracy = timesAnswered > 0 ? Math.round((timesCorrect / timesAnswered) * 100) : 0;

                return `
                    <div class="seen-question-item" onclick="showSeenQuestionDetail(${q.id})" style="
                        padding: 15px;
                        margin-bottom: 10px;
                        background: var(--bg);
                        border-radius: 8px;
                        border: 1px solid var(--border);
                        cursor: pointer;
                        transition: all 0.2s;
                    " onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                            <div style="flex: 1;">
                                <div style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 5px;">
                                    #${q.id} â€¢ ${q.domain} â€¢
                                    <span class="difficulty-badge difficulty-${q.difficulty}" style="font-size: 0.7rem; padding: 2px 6px;">${q.difficulty}</span>
                                </div>
                                <div style="font-weight: 500; line-height: 1.4;">
                                    ${q.question.length > 120 ? q.question.substring(0, 120) + '...' : q.question}
                                </div>
                            </div>
                            <div style="text-align: right; min-width: 80px;">
                                ${timesAnswered > 0 ? `
                                    <div style="font-size: 0.85rem; color: ${accuracy >= 70 ? 'var(--success)' : accuracy >= 50 ? 'var(--warning)' : 'var(--danger)'}; font-weight: 600;">
                                        ${accuracy}% correct
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">
                                        ${timesCorrect}/${timesAnswered} attempts
                                    </div>
                                ` : `
                                    <div style="font-size: 0.8rem; color: var(--text-light);">Seen</div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showSeenQuestionDetail(questionId) {
            const question = questionBank.find(q => q.id === questionId);
            if (!question) return;

            const stats = state.questionStats?.[questionId];

            // Create a modal-like display
            const listEl = document.getElementById('seenQuestionsList');
            listEl.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 20px; border: 2px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span class="difficulty-badge difficulty-${question.difficulty}">${question.difficulty.toUpperCase()}</span>
                        <button onclick="filterSeenQuestions()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;">â† Back to List</button>
                    </div>

                    <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 10px;">
                        #${question.id} â€¢ ${question.domain}
                    </div>

                    ${question.vignette ? `<div class="vignette" style="margin-bottom: 15px;">${question.vignette}</div>` : ''}

                    <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 20px;">${question.question}</div>

                    <div style="margin-bottom: 20px;">
                        ${question.options.map((opt, idx) => `
                            <div style="padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 2px solid ${idx === question.correct ? 'var(--success)' : 'var(--border)'}; background: ${idx === question.correct ? 'var(--success-light)' : 'var(--bg)'};">
                                <strong>${String.fromCharCode(65 + idx)})</strong> ${opt}
                                ${idx === question.correct ? ' âœ“' : ''}
                            </div>
                        `).join('')}
                    </div>

                    <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>Explanation:</strong> ${question.explanation}
                    </div>

                    <div style="font-size: 0.85rem; color: var(--text-light);">
                        <strong>Citation:</strong> ${question.citation}
                    </div>

                    ${question.studyUrls && question.studyUrls.length > 0 ? `
                        <div style="margin-top: 10px; font-size: 0.85rem;">
                            <strong>Study Links:</strong>
                            ${question.studyUrls.map(url => `<a href="${url}" target="_blank" style="display: block; color: var(--primary);">${url}</a>`).join('')}
                        </div>
                    ` : ''}

                    ${stats ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); font-size: 0.85rem; color: var(--text-light);">
                            <strong>Your Stats:</strong> Answered ${stats.timesAnswered || 0} times, correct ${stats.timesCorrect || 0} times
                            (${stats.timesAnswered > 0 ? Math.round((stats.timesCorrect / stats.timesAnswered) * 100) : 0}%)
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Auto-save every 30 seconds
        setInterval(() => {
            if (state.currentSession.questions.length > 0) {
                saveUserData();
            }
        }, 30000);


        // ===================================
        // ACCESSIBILITY FUNCTIONS
        // ===================================
        
        function toggleAccessibility() {
            const panel = document.getElementById('accessibilityPanel');
            panel.classList.toggle('hidden');
        }
        
        function updateFontSize(size) {
            const sizeNum = parseInt(size);
            
            // Update display with helpful label
            let label = '';
            if (sizeNum <= 16) label = ' (Small)';
            else if (sizeNum <= 24) label = ' (Normal)';
            else if (sizeNum <= 40) label = ' (Large)';
            else if (sizeNum <= 60) label = ' (Very Large)';
            else label = ' (Huge)';
            
            document.getElementById('fontSizeValue').textContent = size + 'px' + label;
            document.body.style.fontSize = size + 'px';
            state.preferences.fontSize = sizeNum;
            
            // Add visual feedback
            console.log('ðŸ“ Font size changed to ' + size + 'px' + label);
        }
        
        function updateTheme(theme) {
            document.body.classList.remove('theme-light', 'theme-dark', 'theme-highcontrast', 'theme-dyslexia');
            if (theme !== 'light') {
                document.body.classList.add('theme-' + theme);
            }
            state.preferences.theme = theme;
        }
        
        function updateLineSpacing(spacing) {
            document.body.style.lineHeight = spacing;
            state.preferences.lineSpacing = parseFloat(spacing);
        }
        
        function savePreferences() {
            saveUserData();
            alert('âœ… Accessibility preferences saved!');
            toggleAccessibility();
        }
        
        function loadPreferences() {
            if (state.preferences) {
                if (state.preferences.fontSize) {
                    document.getElementById('fontSizeSlider').value = state.preferences.fontSize;
                    updateFontSize(state.preferences.fontSize);
                }
                if (state.preferences.theme) {
                    document.getElementById('themeSelect').value = state.preferences.theme;
                    updateTheme(state.preferences.theme);
                }
                if (state.preferences.lineSpacing) {
                    document.getElementById('lineSpacingSelect').value = state.preferences.lineSpacing;
                    updateLineSpacing(state.preferences.lineSpacing);
                }
                // Load running score preference
                const showScore = state.preferences.showRunningScore !== false;
                document.getElementById('runningScoreToggle').checked = showScore;
                applyRunningScoreVisibility(showScore);
            }
            // Populate the name settings input
            document.getElementById('settingsUserName').value = state.userName || '';
        }

        // Running score functions
        function toggleRunningScore(show) {
            state.preferences.showRunningScore = show;
            saveUserData();
            applyRunningScoreVisibility(show);
        }

        function applyRunningScoreVisibility(show) {
            const scoreDisplay = document.getElementById('runningScoreDisplay');
            if (scoreDisplay) {
                scoreDisplay.style.display = show ? 'inline-block' : 'none';
            }
        }

        function updateRunningScore() {
            const session = state.currentSession;
            const scoreDisplay = document.getElementById('runningScore');
            const scoreContainer = document.getElementById('runningScoreDisplay');

            if (!scoreDisplay || !scoreContainer) return;

            // Hide if preference is off
            if (state.preferences.showRunningScore === false) {
                scoreContainer.style.display = 'none';
                return;
            }
            scoreContainer.style.display = 'inline-block';

            // Calculate current score
            let correct = 0;
            let answered = 0;
            for (const questionId in session.answers) {
                const question = session.questions.find(q => q.id === parseInt(questionId));
                if (question) {
                    answered++;
                    if (session.answers[questionId] === question.correct) {
                        correct++;
                    }
                }
            }

            // Display score
            if (answered === 0) {
                scoreDisplay.textContent = '0%';
                scoreContainer.style.background = 'var(--primary-light)';
                scoreContainer.style.color = 'var(--primary)';
            } else {
                const percentage = Math.round((correct / answered) * 100);
                scoreDisplay.textContent = `${percentage}%`;

                // Color based on score
                if (percentage >= 70) {
                    scoreContainer.style.background = 'var(--success-light)';
                    scoreContainer.style.color = 'var(--success)';
                } else if (percentage >= 50) {
                    scoreContainer.style.background = 'var(--warning-light)';
                    scoreContainer.style.color = 'var(--warning)';
                } else {
                    scoreContainer.style.background = 'var(--danger-light)';
                    scoreContainer.style.color = 'var(--danger)';
                }
            }
        }

        // ===================================
        // QUESTION RATING & FEEDBACK FUNCTIONS
        // ===================================

        function rateQuestion(questionId, rating) {
            // Initialize ratings object if needed
            if (!state.questionRatings) state.questionRatings = {};
            if (!state.questionStats) state.questionStats = {};

            // Get previous rating
            const previousRating = state.questionRatings[questionId];

            // Only send to Google Forms if this is a new rating (not changing existing)
            const isNewRating = !previousRating;

            // Update user's rating
            state.questionRatings[questionId] = rating;

            // Initialize question stats if needed
            if (!state.questionStats[questionId]) {
                state.questionStats[questionId] = {
                    timesAnswered: 0,
                    timesCorrect: 0,
                    good: 0,
                    irrelevant: 0,
                    incorrect: 0,
                    issue: 0
                };
            }

            // Update aggregate stats (local only - for your review)
            const stats = state.questionStats[questionId];

            // Remove previous rating if exists
            if (previousRating && stats[previousRating] !== undefined) {
                stats[previousRating] = Math.max(0, stats[previousRating] - 1);
            }

            // Add new rating
            if (stats[rating] !== undefined) {
                stats[rating]++;
            }

            saveUserData();

            // Send to Google Forms (only for new ratings to avoid duplicates)
            if (isNewRating) {
                const session = state.currentSession;
                const question = session.questions.find(q => q.id === questionId);
                const wasCorrect = session.answers[questionId] === question?.correct;
                sendRatingToGoogleForms(questionId, rating, question, wasCorrect);
            }

            // Update UI
            showQuestion();

            // Log for analytics
            console.log(`Question ${questionId} rated: ${rating}`, stats);
        }

        function trackQuestionAnswer(questionId, isCorrect) {
            if (!state.questionStats) state.questionStats = {};

            if (!state.questionStats[questionId]) {
                state.questionStats[questionId] = {
                    timesAnswered: 0,
                    timesCorrect: 0,
                    good: 0,
                    irrelevant: 0,
                    incorrect: 0,
                    issue: 0
                };
            }

            state.questionStats[questionId].timesAnswered++;
            if (isCorrect) {
                state.questionStats[questionId].timesCorrect++;
            }
        }

        function getQuestionDifficulty(questionId) {
            const stats = state.questionStats[questionId];
            if (!stats || stats.timesAnswered < 3) return null;

            const correctRate = stats.timesCorrect / stats.timesAnswered;
            if (correctRate >= 0.8) return 'easy';
            if (correctRate >= 0.5) return 'medium';
            return 'hard';
        }

        function getProblematicQuestions() {
            // Returns questions that may need revision
            const problematic = [];

            for (const questionId in state.questionStats) {
                const stats = state.questionStats[questionId];
                const totalRatings = (stats.good || 0) + (stats.irrelevant || 0) + (stats.incorrect || 0) + (stats.issue || 0);
                const negativeRatings = (stats.irrelevant || 0) + (stats.incorrect || 0) + (stats.issue || 0);

                // Flag questions marked as having incorrect answer
                if (stats.incorrect > 0) {
                    problematic.push({
                        questionId: parseInt(questionId),
                        stats: stats,
                        reason: 'Marked as incorrect answer',
                        severity: 'high'
                    });
                }

                // Flag questions marked as irrelevant
                if (stats.irrelevant > 0) {
                    problematic.push({
                        questionId: parseInt(questionId),
                        stats: stats,
                        reason: 'Marked as irrelevant',
                        severity: 'medium'
                    });
                }

                // Flag if high ratio of issues
                if (totalRatings >= 3 && negativeRatings / totalRatings > 0.3) {
                    problematic.push({
                        questionId: parseInt(questionId),
                        stats: stats,
                        reason: 'High negative rating ratio',
                        severity: 'medium'
                    });
                }

                // Flag if very low correct rate with enough attempts
                if (stats.timesAnswered >= 5 && stats.timesCorrect / stats.timesAnswered < 0.2) {
                    problematic.push({
                        questionId: parseInt(questionId),
                        stats: stats,
                        reason: 'Very low correct rate (<20%)',
                        severity: 'low'
                    });
                }
            }

            return problematic;
        }

        function generateUniqueUserId() {
            if (!state.uniqueUserId) {
                state.uniqueUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                saveUserData();
            }
            return state.uniqueUserId;
        }

        // ===================================
        // SESSION HISTORY FUNCTIONS
        // ===================================

        function showSessionHistory() {
            hideAllScreens();
            document.getElementById('sessionHistory').classList.remove('hidden');
            renderSessionHistory('all');
            updateSeenQuestionsDisplay();
        }
        
        function filterSessions(filter) {
            // Update active button
            document.querySelectorAll('.review-filters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderSessionHistory(filter);
        }
        
        function renderSessionHistory(filter) {
            const container = document.getElementById('sessionHistoryList');
            
            if (!state.sessions || state.sessions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <div style="font-size: 3rem; margin-bottom: 16px;">ðŸ“š</div>
                        <p>No sessions yet. Complete your first practice session to see it here!</p>
                    </div>
                `;
                return;
            }
            
            let sessions = [...state.sessions].reverse(); // Newest first
            
            // Filter sessions
            if (filter === 'passed') {
                sessions = sessions.filter(s => s.score >= 70);
            } else if (filter === 'failed') {
                sessions = sessions.filter(s => s.score < 70);
            }
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <p>No sessions match this filter.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = sessions.map(session => {
                const date = new Date(session.date);
                const scoreClass = session.score >= 70 ? 'passing' : 'failing';
                const scoreIcon = session.score >= 70 ? 'âœ…' : 'âŒ';
                
                return `
                    <div class="session-history-card" onclick="reviewSession('${session.id}')">
                        <div class="session-header">
                            <div class="session-date">${date.toLocaleDateString()} at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                            <div class="session-score ${scoreClass}">${scoreIcon} ${session.score}%</div>
                        </div>
                        <div class="session-details">
                            <span><strong>${session.correct}</strong> / ${session.total} correct</span>
                            <span>Mode: <strong>${session.mode === 'practice' ? 'ðŸŽ¯ Practice' : 'ðŸ“ Exam'}</strong></span>
                            <span>Time: <strong>${Math.floor(session.duration / 60)}m ${session.duration % 60}s</strong></span>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.85rem; color: var(--text-light);">
                            Domains: ${session.domains.join(', ')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ===================================
        // SESSION REVIEW FUNCTIONS
        // ===================================
        
        function reviewSession(sessionId) {
            const session = state.sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            hideAllScreens();
            document.getElementById('sessionReview').classList.remove('hidden');
            
            // Show session header
            const scoreClass = session.score >= 70 ? 'passing' : 'failing';
            const scoreIcon = session.score >= 70 ? 'âœ…' : 'âŒ';
            const date = new Date(session.date);
            
            document.getElementById('sessionReviewHeader').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <div style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 4px;">
                            ${date.toLocaleDateString()} at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </div>
                        <div style="font-size: 1.2rem; font-weight: 600;">
                            ${session.mode === 'practice' ? 'ðŸŽ¯ Practice Mode' : 'ðŸ“ Exam Simulation'}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div class="session-score ${scoreClass}" style="font-size: 2rem;">${scoreIcon} ${session.score}%</div>
                        <div style="font-size: 0.9rem; color: var(--text-light);">${session.correct} / ${session.total} correct</div>
                    </div>
                </div>
            `;
            
            // Store current review session
            window.currentReviewSession = session;
            
            // Render questions
            filterReviewQuestions('all');
        }
        
        function filterReviewQuestions(filter) {
            // Update active button
            document.querySelectorAll('#sessionReview .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const session = window.currentReviewSession;
            if (!session) return;
            
            let questions = session.questions;
            
            // Filter questions
            if (filter === 'correct') {
                questions = questions.filter(q => q.isCorrect);
            } else if (filter === 'incorrect') {
                questions = questions.filter(q => !q.isCorrect);
            } else if (filter === 'flagged') {
                questions = questions.filter(q => state.questionNotes[q.questionId]?.flagged);
            }
            
            const container = document.getElementById('reviewQuestionsList');
            
            if (questions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <p>No questions match this filter.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = questions.map((q, index) => {
                const isFlagged = state.questionNotes[q.questionId]?.flagged || false;
                const note = state.questionNotes[q.questionId]?.note || '';
                const correctClass = q.isCorrect ? 'correct' : 'incorrect';
                const resultIcon = q.isCorrect ? 'âœ…' : 'âŒ';
                
                return `
                    <div class="review-question ${correctClass}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="font-weight: 600; color: var(--text-light);">
                                Question ${index + 1} of ${questions.length} ${resultIcon}
                            </div>
                            <button class="flag-btn ${isFlagged ? 'flagged' : ''}" onclick="toggleFlag('${q.questionId}')">
                                ${isFlagged ? 'ðŸš© Flagged' : 'ðŸ´ Flag'}
                            </button>
                        </div>
                        
                        ${q.vignette ? `<div style="background: var(--bg); padding: 16px; border-radius: 8px; margin-bottom: 16px; font-style: italic; border-left: 3px solid var(--primary);">${q.vignette}</div>` : ''}
                        
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 16px;">${q.questionText}</div>
                        
                        <div class="options-container">
                            ${q.options.map((opt, i) => {
                                let classes = ['answer-option'];
                                if (i === q.userAnswer) classes.push('user-answer');
                                if (i === q.correctAnswer) classes.push('correct-answer');
                                
                                let prefix = '';
                                if (i === q.userAnswer && i === q.correctAnswer) prefix = 'âœ… Your answer (Correct): ';
                                else if (i === q.userAnswer) prefix = 'âŒ Your answer: ';
                                else if (i === q.correctAnswer) prefix = 'âœ… Correct answer: ';
                                
                                return `<div class="${classes.join(' ')}">${prefix}${opt}</div>`;
                            }).join('')}
                        </div>
                        
                        <div style="margin-top: 20px; padding: 16px; background: var(--bg); border-radius: 8px;">
                            <div style="font-weight: 600; color: var(--primary); margin-bottom: 8px;">ðŸ“š Explanation:</div>
                            <div style="margin-bottom: 12px;">${q.explanation}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light); font-style: italic; margin-bottom: 12px;">
                                ðŸ“– ${q.citation}
                            </div>
                            <div class="study-links">
                                <strong>ðŸ”— Learn More:</strong>
                                ${getStudyUrls(q).map(link =>
                                    `<a href="${link.url}" target="_blank" rel="noopener noreferrer" class="study-link">${link.title} â†’</a>`
                                ).join('')}
                            </div>
                            ${q.memoryTip ? `
                            <div class="memory-tip">
                                <div class="memory-tip-header">
                                    <span>ðŸ’¡</span> Memory Tip
                                </div>
                                <div class="memory-tip-content">${q.memoryTip}</div>
                            </div>
                            ` : ''}
                        </div>

                        <div class="note-section">
                            <label style="font-weight: 600; display: block; margin-bottom: 8px;">
                                ðŸ’­ Your Personal Note:
                            </label>
                            <textarea 
                                class="note-textarea" 
                                placeholder="Add a note to help you remember this concept..."
                                onchange="saveQuestionNote('${q.questionId}', this.value)"
                            >${note}</textarea>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ===================================
        // NOTES & FLAGGING FUNCTIONS
        // ===================================
        
        function saveQuestionNote(questionId, note) {
            if (!state.questionNotes[questionId]) {
                state.questionNotes[questionId] = { note: '', flagged: false };
            }
            state.questionNotes[questionId].note = note;
            saveUserData();
        }
        
        function toggleFlag(questionId) {
            if (!state.questionNotes[questionId]) {
                state.questionNotes[questionId] = { note: '', flagged: false };
            }
            state.questionNotes[questionId].flagged = !state.questionNotes[questionId].flagged;
            
            // Update flagged count
            state.stats.flaggedCount = Object.values(state.questionNotes).filter(n => n.flagged).length;
            
            saveUserData();
            updateDashboardStats();
            
            // Re-render if we're in review mode
            if (window.currentReviewSession) {
                filterReviewQuestions(document.querySelector('#sessionReview .filter-btn.active').textContent.includes('Flagged') ? 'flagged' : document.querySelector('#sessionReview .filter-btn.active').textContent.includes('Incorrect') ? 'incorrect' : document.querySelector('#sessionReview .filter-btn.active').textContent.includes('Correct') ? 'correct' : 'all');
            }
        }
        
        function showStudyNotes() {
            hideAllScreens();
            document.getElementById('studyNotes').classList.remove('hidden');
            renderStudyNotes();
        }
        
        function renderStudyNotes() {
            const container = document.getElementById('studyNotesList');
            const notesWithContent = Object.entries(state.questionNotes).filter(([id, data]) => data.note);
            
            if (notesWithContent.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <div style="font-size: 3rem; margin-bottom: 16px;">ðŸ“</div>
                        <p>No notes yet. Add notes while reviewing questions to see them here!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = notesWithContent.map(([questionId, data]) => {
                const question = questionBank.find(q => q.id === parseInt(questionId));
                if (!question) return '';
                
                return `
                    <div class="review-question" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <div style="font-weight: 600; color: var(--primary);">Question #${questionId}</div>
                                <div style="font-size: 0.9rem; color: var(--text-light);">${question.domain}</div>
                            </div>
                            ${data.flagged ? '<span class="note-indicator">ðŸš© Flagged</span>' : ''}
                        </div>
                        <div style="font-size: 1.05rem; margin-bottom: 12px;">${question.question}</div>
                        <div style="background: var(--warning-light); padding: 12px; border-radius: 8px; border-left: 3px solid var(--warning);">
                            <div style="font-weight: 600; margin-bottom: 4px;">ðŸ’­ Your Note:</div>
                            <div>${data.note}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function exportStudyNotes() {
            const notesWithContent = Object.entries(state.questionNotes).filter(([id, data]) => data.note);
            
            if (notesWithContent.length === 0) {
                alert('No notes to export!');
                return;
            }
            
            let text = `MFT Exam Master - Study Notes\n`;
            text += `Exported: ${new Date().toLocaleString()}\n`;
            text += `Total Notes: ${notesWithContent.length}\n`;
            text += `\n${'='.repeat(80)}\n\n`;
            
            notesWithContent.forEach(([questionId, data]) => {
                const question = questionBank.find(q => q.id === parseInt(questionId));
                if (!question) return;
                
                text += `Question #${questionId}${data.flagged ? ' [FLAGGED]' : ''}\n`;
                text += `Domain: ${question.domain}\n`;
                text += `Difficulty: ${question.difficulty}\n\n`;
                text += `Question: ${question.question}\n\n`;
                text += `YOUR NOTE:\n${data.note}\n\n`;
                text += `${'-'.repeat(80)}\n\n`;
            });
            
            // Create download
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MFT_Study_Notes_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('âœ… Study notes exported!');
        }
        
        // ===================================
        // DASHBOARD STATS UPDATE
        // ===================================
        
        function updateDashboardStats() {
            document.getElementById('statTotalSessions').textContent = state.stats.totalSessions || 0;
            
            const avgScore = state.stats.totalQuestions > 0
                ? Math.round((state.stats.totalCorrect / state.stats.totalQuestions) * 100)
                : 0;
            document.getElementById('statAvgScore').textContent = avgScore + '%';
            
            document.getElementById('statFlaggedQuestions').textContent = state.stats.flaggedCount || 0;
        }

        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>
